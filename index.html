<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Aprova√ß√£o de Mockup ‚Äì Gama Laser</title>

<!-- FAVICON (sol laranja) -->
<link rel="icon" href="https://zqaoxvxuznonytzibhhe.supabase.co/storage/v1/object/public/imagens_gamalaser/LOGO-GAMA-LASER.png" />

<style>
:root{
  --orange:#f68729; --bg:#000; --white:#fff; --muted:#6b7280; --shadow:0 10px 30px rgba(0,0,0,.18);
  --border:#eaeaea; --panel:#ffffff; --ink:#111827; --tag:#111;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
/* ======== HEADER BRANCO ======== */
.top-white{background:#fff;border-bottom:3px solid var(--orange)}
.top-inner{max-width:1100px;margin:0 auto;padding:22px 16px;text-align:center}
.top-inner .brand img{width:200px;height:auto}
.top-inner .order{margin-top:10px;color:var(--orange);font-weight:800}
.top-inner .order small{display:block;color:#d97706;font-weight:700;opacity:.95}

/* ======== LAYOUT ======== */
.shell{max-width:1100px;margin:26px auto;padding:0 16px;display:grid;grid-template-columns:1fr 340px;gap:18px}
@media (max-width:980px){.shell{grid-template-columns:1fr}}
.card{background:var(--panel);border-radius:16px;box-shadow:var(--shadow)}
.pad{padding:16px}

/* progresso de produtos */
.progress{display:flex;gap:8px;justify-content:center;margin:6px 0 12px}
.dot{width:10px;height:10px;border-radius:99px;background:#e5e7eb;transition:.2s}
.dot.active{background:var(--orange);transform:scale(1.15)}
.dot.done{background:#22c55e}

/* linha do produto */
.meta{color:#374151;font-size:15px;margin:4px 0 12px}
.meta strong{color:#111}

/* ======== STAGE / EDITOR ======== */
.stage-wrap{padding:18px}
.stage{position:relative;width:100%;background:#fafafa;border-radius:14px;overflow:hidden;box-shadow:inset 0 0 0 1px #eee}
.stage::after{content:"";display:block;padding-top:75%} /* 4:3 default; ser√° substitu√≠do no onload */
.stage > img.base{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:#fff}

/* camadas */
.layer{position:absolute;translate:-50% -50%;outline:2px dashed rgba(0,0,0,.25);border-radius:10px;user-select:none;touch-action:none}
.layer .tag{position:absolute;top:-24px;left:0;background:rgba(17,17,17,.7);color:#fff;font-size:11px;font-weight:800;padding:3px 6px;border-radius:6px}
.layer.small .tag{display:none} /* oculta tag quando pequeno */
.handles{position:absolute;inset:-8px;pointer-events:none}
.handle{position:absolute;width:12px;height:12px;border:2px solid #0ea5e9;background:#fff;border-radius:2px;pointer-events:auto;cursor:nwse-resize}
.handle.tl{left:-6px;top:-6px}
.handle.br{right:-6px;bottom:-6px}

.logo-box img{display:block;width:100%;height:100%;object-fit:contain;pointer-events:none}
.text-box{display:flex;align-items:center;justify-content:center;line-height:1;white-space:pre;color:#000;padding:6px 8px;transform-origin:center}
.text-vertical{writing-mode:vertical-rl}

/* ======== PANEL LATERAL ======== */
.section{padding:14px;border-bottom:1px solid var(--border)}
.section:last-child{border-bottom:0}
h3{margin:0 0 8px;font-size:16px}
label{display:block;font-size:13px;font-weight:700;margin:6px 0}
input[type="text"],select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:14px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;width:100%;border:0;border-radius:10px;padding:12px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--orange);color:#fff}
.btn.dark{background:#111;color:#fff}
.btn.gray{background:#e5e7eb}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}

.coords{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f172a;color:#93c5fd;padding:10px 12px;border-radius:10px;font-size:12px;white-space:pre-wrap;margin-top:10px}

.error{background:#fee2e2;border:1px solid #ef4444;color:#991b1b;padding:10px 12px;border-radius:10px;display:none}
.success{background:#ecfdf5;border:1px solid #10b981;color:#065f46;padding:12px;border-radius:10px;display:none}
.hide{display:none!important}

/* ======== OVERLAY DE PROGRESSO ======== */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99}
.overlay .box{background:#fff;border-radius:14px;box-shadow:var(--shadow);width:min(420px,92vw);padding:22px 18px;text-align:center}
.progress-bar{position:relative;height:12px;background:#eee;border-radius:999px;overflow:hidden;margin-top:14px}
.progress-fill{position:absolute;left:0;top:0;height:100%;width:0%;background:var(--orange);transition:width .3s ease}
.progress-value{margin-top:10px;color:#374151;font-weight:700}

/* ======== TELA FINAL ======== */
.final{display:none;max-width:760px;margin:28px auto;padding:22px;background:#fff;border-radius:16px;box-shadow:var(--shadow);text-align:center}
.final img{width:180px}
.final h2{color:#16a34a}
</style>
</head>
<body>

<!-- HEADER BRANCO COM LOGO E DADOS DO PEDIDO -->
<div class="top-white">
  <div class="top-inner">
    <div class="brand">
      <img src="https://zqaoxvxuznonytzibhhe.supabase.co/storage/v1/object/public/imagens_gamalaser/LOGO-GAMA-LASER.png" alt="Gama Laser">
    </div>
    <div class="order">
      <div id="orderLine">Pedido #‚Äî</div>
      <small id="orderSub">‚Äî</small>
    </div>
  </div>
</div>

<!-- APP -->
<div class="shell">
  <!-- Painel branco com editor -->
  <div class="card pad">
    <div id="msgError" class="error">‚Äî</div>
    <div id="msgOk" class="success">‚Äî</div>

    <!-- indicador ‚ÄúProduto x de y‚Äù -->
    <div id="progress" class="progress"></div>

    <div class="meta">
      <strong id="cap">Produto 1 de 1</strong> ‚Äî <span id="pNome">‚Äî</span> ¬∑
      <strong>Variante:</strong> <span id="pVariante">‚Äî</span> ¬∑
      <strong>SKU:</strong> <span id="pSku">‚Äî</span> ¬∑
      <strong>Qtd:</strong> <span id="pQtd">‚Äî</span>
    </div>

    <!-- STAGE -->
    <div id="stage" class="stage">
      <img id="baseImg" class="base" alt="mockup">

      <!-- TEXTO (drag/resize/rotate) -->
      <div id="textLayer" class="layer hide" data-type="text">
        <div class="tag">‚úèÔ∏è TEXTO</div>
        <div id="textBox" class="text-box">Seu texto</div>
        <div class="handles"><div class="handle tl" data-resize="tl"></div><div class="handle br" data-resize="br"></div></div>
      </div>

      <!-- LOGO (drag/resize/rotate) -->
      <div id="logoLayer" class="layer hide" data-type="logo" style="width:110px;height:110px;">
        <div class="tag">üì∑ LOGO</div>
        <div class="logo-box"><img id="logoImg" alt="logo"></div>
        <div class="handles"><div class="handle tl" data-resize="tl"></div><div class="handle br" data-resize="br"></div></div>
      </div>
    </div>

    <div id="coords" class="coords">‚Äî</div>
  </div>

  <!-- Painel de controles -->
  <div class="card">
    <div class="section">
      <h3>1) Selecione e gere a pr√©via</h3>
      <label>Logo (arquivo)</label>
      <input id="logoInput" type="file" accept="image/*">
      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Texto (20 caract.)</label>
          <input id="textInput" type="text" maxlength="20" placeholder="Digite o texto‚Ä¶">
        </div>
        <div>
          <label>Fonte</label>
          <select id="fontSelect">
            <option>Arial</option><option>Helvetica</option><option>Times</option>
            <option>Verdana</option><option>Courier</option><option>Impact</option><option>Georgia</option>
          </select>
        </div>
      </div>
      <button id="btnPreview" class="btn dark" style="margin-top:12px">üîç Gerar pr√©via</button>
    </div>

    <div id="editSection" class="section hide">
      <h3>2) Ajuste livre</h3>
      <div class="grid3" style="margin-top:8px">
        <button id="btnRotateLogo" class="btn gray">‚§¥Ô∏è Rotacionar Logo 90¬∞</button>
        <button id="btnRotateText" class="btn gray">‚Üª Rotacionar Texto 90¬∞</button>
        <button id="btnReset" class="btn gray">‚Ü∫ Resetar</button>
      </div>
      <div class="grid2" style="margin-top:8px">
        <button id="btnLogoMinus" class="btn gray">‚àí Logo</button>
        <button id="btnLogoPlus" class="btn gray">+ Logo</button>
      </div>
      <div class="grid2" style="margin-top:8px">
        <button id="btnTextMinus" class="btn gray">‚àí Texto</button>
        <button id="btnTextPlus" class="btn gray">+ Texto</button>
      </div>
    </div>

    <div id="approveSection" class="section hide">
      <h3>3) Aprovar</h3>
      <p class="muted" style="margin:0 0 8px">Geraremos a URL final (Cloudinary) com logo e texto aplicados.</p>
      <button id="btnApprove" class="btn primary">‚úÖ Aprovar este produto</button>
    </div>
  </div>
</div>

<!-- OVERLAY DE PROGRESSO -->
<div id="overlay" class="overlay" role="dialog" aria-live="polite">
  <div class="box">
    <div style="font-weight:800">Gerando pr√©via‚Ä¶</div>
    <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
    <div id="progressValue" class="progress-value">0%</div>
  </div>
</div>

<!-- TELA FINAL -->
<div id="finalScreen" class="final">
  <img src="https://zqaoxvxuznonytzibhhe.supabase.co/storage/v1/object/public/imagens_gamalaser/LOGO-GAMA-LASER.png" alt="Gama Laser">
  <h2>üéâ Todos os produtos foram aprovados!</h2>
  <p>Obrigado! Seu pedido seguir√° para a produ√ß√£o.</p>
</div>

<script>
/* ================= CONFIG ================= */
const CLOUD_NAME = 'dslzqtajk';
const WEBHOOK_PREVIEW   = 'https://gama-laser-n8n.gtyipj.easypanel.host/webhook-test/gerar-preview-mockup'; // ajuste quando precisar
const SUPABASE_URL      = 'https://zqaoxvxuznonytzibhhe.supabase.co';
const SUPABASE_KEY      = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxYW94dnh1em5vbnl0emliaGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDYwMTEsImV4cCI6MjA3NTEyMjAxMX0.anrCkp8mdxVPg1lpCqvnz_OxLk3ljNz1veTMPWSjtpI';

/* ================= STATE ================= */
let linkId='', orderNumber='', produtos=[], idxAtual=0;
let mockupPublicId='', logoPublicId='', fonte='Arial', texto='', hasText=false;

const state = { logo:{x:.30,y:.30,w:110,rot:0}, text:{x:.55,y:.30,font:28,rot:0} };

/* ================= ELTS ================= */
const msgError=document.getElementById('msgError'), msgOk=document.getElementById('msgOk');
const orderLine=document.getElementById('orderLine'), orderSub=document.getElementById('orderSub');
const progress=document.getElementById('progress'), cap=document.getElementById('cap');
const pNome=document.getElementById('pNome'), pVar=document.getElementById('pVariante'), pSku=document.getElementById('pSku'), pQtd=document.getElementById('pQtd');

const stage=document.getElementById('stage'), baseImg=document.getElementById('baseImg');
const textLayer=document.getElementById('textLayer'), textBox=document.getElementById('textBox');
const logoLayer=document.getElementById('logoLayer'), logoImg=document.getElementById('logoImg');
const coords=document.getElementById('coords');

const logoInput=document.getElementById('logoInput'), textInput=document.getElementById('textInput'), fontSelect=document.getElementById('fontSelect');
const btnPreview=document.getElementById('btnPreview'), editSection=document.getElementById('editSection'), approveSection=document.getElementById('approveSection');
const btnRotateLogo=document.getElementById('btnRotateLogo'), btnRotateText=document.getElementById('btnRotateText'), btnReset=document.getElementById('btnReset');
const btnLogoMinus=document.getElementById('btnLogoMinus'), btnLogoPlus=document.getElementById('btnLogoPlus'), btnTextMinus=document.getElementById('btnTextMinus'), btnTextPlus=document.getElementById('btnTextPlus'), btnApprove=document.getElementById('btnApprove');

const overlay=document.getElementById('overlay'), progressFill=document.getElementById('progressFill'), progressValue=document.getElementById('progressValue');
const finalScreen=document.getElementById('finalScreen');

/* ================= UTILS ================= */
function showError(m){msgError.textContent=m;msgError.style.display='block';setTimeout(()=>msgError.style.display='none',6000);}
function showOk(m){msgOk.textContent=m;msgOk.style.display='block';setTimeout(()=>msgOk.style.display='none',2500);}
const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
const px=n=>`${Math.round(n)}px`;
function setHidden(el,cond){el.classList.toggle('hide',cond);}
function stageRect(){return stage.getBoundingClientRect();}

/* ================= CARREGAR PEDIDO ================= */
async function carregarPedido(){
  const params=new URLSearchParams(location.search);
  linkId=params.get('p')||'';
  if(!linkId){showError('Link inv√°lido. Use ?p=SEU_LINK_ID');return;}

  try{
    const r=await fetch(`${SUPABASE_URL}/rest/v1/links_aprovacao?id=eq.${linkId}&select=*`,{headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}});
    const data=await r.json();
    if(!data?.length){showError('Link n√£o encontrado.');return;}
    const row=data[0];
    orderNumber=row.order_number ?? row.order_id ?? '';
    const arr=typeof row.produtos==='string' ? JSON.parse(row.produtos) : row.produtos;
    produtos=Array.isArray(arr)?arr:[];
    if(!produtos.length){showError('Nenhum produto neste link.');return;}

    orderLine.textContent=`Pedido #${orderNumber}`;
    orderSub.textContent=`${produtos[0].nome} ‚Äî SKU ${produtos[0].sku}`;

    // Progress dots
    progress.innerHTML='';
    produtos.forEach((_,i)=>{const d=document.createElement('div');d.className='dot'+(i===0?' active':'');d.id=`dot-${i}`;progress.appendChild(d);});

    loadProduto(0);
  }catch(e){console.error(e);showError('Erro ao carregar: '+e.message);}
}

function loadProduto(idx){
  idxAtual=idx;
  const p=produtos[idx];
  cap.textContent=`Produto ${idx+1} de ${produtos.length}`;
  pNome.textContent=p?.nome||'-'; pVar.textContent=p?.variante||'-'; pSku.textContent=p?.sku||'-'; pQtd.textContent=p?.quantidade??'-';
  orderSub.textContent=`${p?.nome||'-'} ‚Äî SKU ${p?.sku||'-'}`;

  // reset
  mockupPublicId=''; logoPublicId=''; fonte='Arial'; texto=''; hasText=false;
  state.logo={x:.30,y:.30,w:110,rot:0}; state.text={x:.55,y:.30,font:28,rot:0};
  baseImg.removeAttribute('src'); logoImg.removeAttribute('src'); textInput.value=''; fontSelect.value='Arial';
  setHidden(textLayer,true); setHidden(logoLayer,true); setHidden(editSection,true); setHidden(approveSection,true);

  // progress UI
  document.querySelectorAll('.dot').forEach((el,i)=>{el.classList.remove('active'); if(i<idx) el.classList.add('done');});
  document.getElementById(`dot-${idx}`)?.classList.add('active');
}

/* ================= PREVIEW ================= */
btnPreview.addEventListener('click', async ()=>{
  const p=produtos[idxAtual];
  const file=logoInput.files?.[0];
  if(!file){showError('Envie um arquivo de logo.');return;}

  texto=(textInput.value||'').trim(); fonte=fontSelect.value||'Arial'; hasText=texto.length>0;

  // overlay progresso
  overlay.style.display='flex'; progressFill.style.width='0%'; progressValue.textContent='0%';
  let prog=0; const t=setInterval(()=>{prog=Math.min(90,prog+2); progressFill.style.width=prog+'%'; progressValue.textContent=prog+'%';},120);

  try{
    const fd=new FormData();
    fd.append('logo',file); fd.append('texto',texto); fd.append('fonte',fonte);
    fd.append('sku',p.sku); fd.append('cor',p.variante);

    const resp=await fetch(WEBHOOK_PREVIEW,{method:'POST',body:fd});
    // se endpoint estiver errado, mostrar√° 404
    let data=null;
    try{ data=await resp.json(); }catch(_){}
    progressFill.style.width='100%'; progressValue.textContent='100%'; setTimeout(()=>{overlay.style.display='none';},250); clearInterval(t);

    if(!resp.ok || !data?.preview_url){ showError('Erro ao gerar pr√©via (verifique o endpoint do n8n).'); return; }

    // Parse: manter APENAS o mockup base (remove overlays)
    mockupPublicId = extractMockupId(data.preview_url);
    logoPublicId   = extractLogoPublicId(data.preview_url);

    // mockup limpo
    baseImg.onload=()=>{ fitStageToImage(); applyPositions(); };
    baseImg.src=`https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${encodeURIComponent(mockupPublicId)}`;

    // logo sem fundo (apenas para visual do editor)
    logoImg.src=`https://res.cloudinary.com/${CLOUD_NAME}/image/upload/e_bgremoval/${encodeURIComponent(logoPublicId)}.png`;

    // texto (apenas camada local)
    textBox.textContent=texto||'';
    setHidden(textLayer,!hasText);
    setHidden(logoLayer,false);
    setHidden(editSection,false);
    setHidden(approveSection,false);
    showOk('Pr√©via pronta. Ajuste livremente.');
  }catch(e){
    clearInterval(t); overlay.style.display='none';
    console.error(e); showError('Falha ao conectar: '+e.message);
  }
});

// extrai s√≥ o caminho final do mockup ap√≥s √∫ltimo fl_layer_apply/
function extractMockupId(url){
  const part=url.split('/upload/')[1]||'';
  const marker='/fl_layer_apply/';
  const last=part.lastIndexOf(marker);
  if(last!==-1) return decodeURIComponent(part.substring(last+marker.length));
  // fallback: pega ap√≥s primeira "/"
  const i=part.indexOf('/');
  return decodeURIComponent(i>=0?part.substring(i+1):part);
}
function extractLogoPublicId(url){
  const m=url.match(/l_([^,]+)/);
  if(!m) return '';
  return decodeURIComponent(m[1]).replaceAll('/',':');
}

/* ======== STAGE helpers ======== */
function fitStageToImage(){
  const nw=baseImg.naturalWidth||0, nh=baseImg.naturalHeight||0;
  if(nw && nh){
    const ratio = (nh/nw)*100;
    stage.style.setProperty('--ratio',ratio);
    // hack: altera o padding-top do pseudo-elemento via style (criamos um child)
    stage.querySelector('.padder')?.remove();
    const d=document.createElement('div'); d.className='padder'; d.style.cssText=`position:absolute;inset:0;opacity:0;pointer-events:none`;
    stage.appendChild(d);
    stage.style.setProperty('--pad', ratio.toFixed(2)+'%');
    stage.style.position='relative';
    stage.style.setProperty('aspect-ratio', `${nw}/${nh}`); // browsers modernos
  }
}

/* ======== APLICA POSI√á√ïES ======== */
function applyPositions(){
  // LOGO
  logoLayer.style.left = (state.logo.x*100)+'%';
  logoLayer.style.top  = (state.logo.y*100)+'%';
  logoLayer.style.width=px(state.logo.w);
  logoLayer.style.height=px(state.logo.w);
  logoLayer.style.transform='translate(-50%,-50%) rotate('+state.logo.rot+'deg)';
  logoLayer.classList.toggle('small', state.logo.w<60);

  // TEXTO
  textBox.style.fontSize=px(state.text.font);
  textBox.style.transform='rotate('+state.text.rot+'deg)';
  textLayer.style.left=(state.text.x*100)+'%';
  textLayer.style.top =(state.text.y*100)+'%';
  // recalcular caixa para acompanhar rota√ß√£o
  requestAnimationFrame(()=>{
    const b=textBox.getBoundingClientRect();
    textLayer.style.width =px(Math.max(28,b.width));
    textLayer.style.height=px(Math.max(22,b.height));
    textLayer.classList.toggle('small', Math.max(b.width,b.height)<60);
    updateCoords();
  });
}

function updateCoords(){
  const r=stage.getBoundingClientRect();
  const lx=Math.round(state.logo.x*r.width), ly=Math.round(state.logo.y*r.height);
  const tx=Math.round(state.text.x*r.width), ty=Math.round(state.text.y*r.height);
  coords.textContent =
`üìç Coordenadas
Logo  ‚Äî X:${lx} Y:${ly} W:${state.logo.w} Rot:${state.logo.rot}¬∞
Texto ‚Äî X:${tx} Y:${ty} Font:${state.text.font} Rot:${state.text.rot}¬∞`;
}

/* ======== DRAG/RESIZE GENERIC ======== */
function initLayerDrag(layer, kind){
  let dragging=false, resizing=false, start={}, rectS, stageR;
  layer.addEventListener('pointerdown',(e)=>{
    const isHandle=e.target.classList.contains('handle');
    dragging=!isHandle; resizing=isHandle?e.target.dataset.resize:false;
    rectS=layer.getBoundingClientRect(); stageR=stage.getBoundingClientRect();
    start={x:e.clientX,y:e.clientY};
    const move=(ev)=>{
      const dx=(ev.clientX-start.x), dy=(ev.clientY-start.y);
      if(dragging){
        const nx=clamp((rectS.left+dx-stageR.left+rectS.width/2)/stageR.width,.02,.98);
        const ny=clamp((rectS.top +dy-stageR.top +rectS.height/2)/stageR.height,.02,.98);
        if(kind==='logo'){ state.logo.x=nx; state.logo.y=ny; } else { state.text.x=nx; state.text.y=ny; }
        applyPositions();
      }
      if(resizing){
        const factor=(rectS.width + dx*(resizing==='br'?1:-1))/rectS.width;
        if(kind==='logo'){ state.logo.w=Math.max(24,Math.round(state.logo.w*factor)); }
        else{ state.text.font=Math.max(8,Math.round(state.text.font*factor)); }
        applyPositions();
        start={x:ev.clientX,y:ev.clientY}; rectS=layer.getBoundingClientRect();
      }
    };
    const up=()=>{document.removeEventListener('pointermove',move);document.removeEventListener('pointerup',up);};
    document.addEventListener('pointermove',move); document.addEventListener('pointerup',up);
  });
}
initLayerDrag(logoLayer,'logo'); initLayerDrag(textLayer,'text');

/* ======== BOT√ïES ======== */
btnRotateLogo.addEventListener('click',()=>{state.logo.rot=(state.logo.rot+90)%360;applyPositions();});
btnRotateText.addEventListener('click',()=>{state.text.rot=(state.text.rot+90)%360;applyPositions();});
btnReset.addEventListener('click',()=>{state.logo={x:.30,y:.30,w:110,rot:0};state.text={x:.55,y:.30,font:28,rot:0};applyPositions();});
btnLogoMinus.addEventListener('click',()=>{state.logo.w=Math.max(24,state.logo.w-6);applyPositions();});
btnLogoPlus .addEventListener('click',()=>{state.logo.w=Math.min(900,state.logo.w+6);applyPositions();});
btnTextMinus.addEventListener('click',()=>{state.text.font=Math.max(8,state.text.font-2);applyPositions();});
btnTextPlus .addEventListener('click',()=>{state.text.font=Math.min(240,state.text.font+2);applyPositions();});
textInput.addEventListener('input',()=>{texto=textInput.value;hasText=texto.trim().length>0;textBox.textContent=texto;setHidden(textLayer,!hasText);applyPositions();});
fontSelect.addEventListener('change',()=>{fonte=fontSelect.value;});

/* ======== APROVAR ======== */
btnApprove.addEventListener('click',()=>{
  if(!mockupPublicId || !logoPublicId){showError('Gere a pr√©via primeiro.');return;}
  const r=stage.getBoundingClientRect();
  const lx=Math.round(state.logo.x*r.width), ly=Math.round(state.logo.y*r.height), logoW=Math.round(state.logo.w);

  // monta URL final (logo + texto)
  let url=`https://res.cloudinary.com/${CLOUD_NAME}/image/upload/`;
  url+=`l_${encodeURIComponent(logoPublicId)},e_bgremoval,w_${logoW},g_north_west,x_${lx},y_${ly}`;
  if(state.logo.rot) url+=`,a_${((state.logo.rot%360)+360)%360}`;
  url+=`/fl_layer_apply/`;
  if(hasText && texto){
    const tx=Math.round(state.text.x*r.width), ty=Math.round(state.text.y*r.height);
    const fontPx=Math.max(8,Math.round(state.text.font)); const safe=texto.replace(/\//g,'\\/');
    url+=`l_text:${fonte}_${fontPx}:${encodeURIComponent(safe)},co_rgb:000000,g_north_west,x_${tx},y_${ty}`;
    if(state.text.rot) url+=`,a_${((state.text.rot%360)+360)%360}`;
    url+=`/fl_layer_apply/`;
  }
  url+=encodeURIComponent(mockupPublicId);
  console.log('URL FINAL:', url);

  // avan√ßa para o pr√≥ximo produto (simula√ß√£o at√© integrar o n8n)
  const next=idxAtual+1;
  if(next<produtos.length){
    document.getElementById(`dot-${idxAtual}`)?.classList.add('done');
    loadProduto(next);
    showOk('Produto aprovado. Indo para o pr√≥ximo‚Ä¶');
  }else{
    document.getElementById(`dot-${idxAtual}`)?.classList.add('done');
    document.querySelector('.shell').style.display='none';
    finalScreen.style.display='block';
  }
});

/* ======== BOOT ======== */
window.addEventListener('load',carregarPedido);
</script>
</body>
</html>
