<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Aprovar Design - Gama Laser</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Arial, sans-serif; background:#000; min-height:100vh; padding-bottom:40px; }
    .header { background:#000; padding:20px; border-bottom:3px solid #f68729; text-align:center; }
    .header img { max-width:200px; height:auto; }

    .container { max-width:960px; margin:40px auto; padding:0 20px; }
    .card { background:#fff; border-radius:16px; padding:30px; box-shadow:0 10px 40px rgba(246,135,41,0.3); }
    .card-title { font-size:28px; color:#000; margin-bottom:10px; text-align:center; }
    .card-subtitle{ color:#666; text-align:center; margin-bottom:25px; font-size:14px; }
    .pedido-info { background:#f0f0f0; border-left:4px solid #f68729; padding:15px; margin-bottom:25px; border-radius:8px; }
    .pedido-info strong { color:#000; font-size:18px; }

    .progress-bar{ display:flex; gap:10px; margin-bottom:25px; justify-content:center; }
    .progress-dot{ width:12px; height:12px; border-radius:50%; background:#ddd; transition:.3s; }
    .progress-dot.active{ background:#f68729; transform:scale(1.3); }
    .progress-dot.completed{ background:#4caf50; }

    .produto-info{ background:#f9f9f9; padding:20px; border-radius:12px; margin-bottom:25px; border:2px solid #f68729; }
    .produto-counter{ text-align:center; color:#f68729; font-weight:bold; font-size:16px; margin-bottom:15px; }
    .produto-detail{ display:flex; align-items:center; gap:10px; margin-bottom:10px; color:#000; font-size:15px; }
    .produto-detail strong{ min-width:100px; }

    .form-group{ margin-bottom:20px; }
    .form-group label{ display:block; font-weight:bold; color:#000; margin-bottom:8px; font-size:15px; }
    .form-group input[type="file"], .form-group input[type="text"], .form-group select{
      width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:14px; transition:border .3s;
    }
    .form-group input:focus, .form-group select:focus{ outline:none; border-color:#f68729; }

    .btn{ width:100%; padding:14px; border:none; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer; transition:.2s; margin-top:10px; }
    .btn-primary{ background:#000; color:#fff; }
    .btn-primary:hover{ background:#333; transform:translateY(-1px); }
    .btn-success{ background:#f68729; color:#fff; }
    .btn-success:hover{ background:#d67420; transform:translateY(-1px); }
    .btn:disabled{ background:#ccc; cursor:not-allowed; }

    .preview-area{ margin-top:30px; padding-top:30px; border-top:2px solid #eee; display:none; }
    .preview-area h3{ color:#f68729; margin-bottom:15px; font-size:20px; }

    .loading-bar{ width:100%; height:30px; background:#eee; border-radius:15px; overflow:hidden; position:relative; margin-bottom:20px; display:none; }
    .loading-progress{ height:100%; background:linear-gradient(90deg,#f68729,#d67420); width:0%; transition:width .5s; border-radius:15px; }
    .loading-text{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:bold; color:#000; font-size:14px; }

    /* Canvas/preview */
    .stage { position:relative; background:#f5f5f5; border:3px solid #ddd; border-radius:12px; overflow:hidden; display:none; user-select:none; touch-action:none; }
    .stage img { width:100%; display:block; pointer-events:none; }

    .instructions{ background:#e0f2fe; border-left:4px solid #0284c7; padding:12px; margin:12px 0 18px; border-radius:8px; font-size:14px; color:#0c4a6e; }
    .instructions strong{ color:#0369a1; }

    .coords{ background:#1a1a1a; color:#0f0; padding:12px; border-radius:8px; margin:12px 0; font-family:"Courier New", monospace; font-size:12px; display:none; }
    .coords div{ margin:4px 0; }

    .panel{ display:none; gap:10px; flex-wrap:wrap; margin:8px 0 0; }
    .panel .mini{ flex:1; min-width:180px; }
    .control-btn{ padding:10px 14px; border:none; border-radius:8px; font-size:14px; font-weight:bold; cursor:pointer; transition:.2s; color:#fff; }
    .control-btn:hover{ transform:scale(1.03); }
    .btn-rotate{ background:#8b5cf6; }
    .btn-rotate:hover{ background:#7c3aed; }
    .btn-verttext{ background:#06b6d4; }
    .btn-verttext:hover{ background:#0891b2; }
    .btn-reset{ background:#ef4444; }
    .btn-reset:hover{ background:#dc2626; }

    /* Marcadores (drag & resize) */
    .marker{ position:absolute; border:2px dashed #f68729; background:rgba(246,135,41,.08); cursor:move; z-index:10; touch-action:none; }
    .marker .label{ position:absolute; top:-22px; left:50%; transform:translateX(-50%); background:#000; color:#fff; font-size:11px; font-weight:bold; padding:2px 6px; border-radius:3px; pointer-events:none; }
    .marker.text{ border-color:#0ea5e9; background:rgba(14,165,233,.08); }
    .handle{ position:absolute; width:12px; height:12px; background:#fff; border:2px solid currentColor; border-radius:2px; z-index:11; }
    .marker.logo .handle{ color:#f68729; }
    .marker.text .handle{ color:#0ea5e9; }
    .handle.tl{ top:-8px; left:-8px; cursor:nwse-resize; }
    .handle.tr{ top:-8px; right:-8px; cursor:nesw-resize; }
    .handle.bl{ bottom:-8px; left:-8px; cursor:nesw-resize; }
    .handle.br{ bottom:-8px; right:-8px; cursor:nwse-resize; }

    .success { background:#d1fae5; border:2px solid #10b981; color:#065f46; padding:30px; border-radius:12px; text-align:center; display:none; margin-top:20px; }
    .error { background:#fee2e2; border:2px solid #ef4444; color:#991b1b; padding:15px; border-radius:8px; margin-top:15px; display:none; }

    .loading-screen{ text-align:center; color:#fff; padding:60px 20px; }
    .spinner{ border:4px solid #333; border-top:4px solid #f68729; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin:20px auto; }
    @keyframes spin { to{ transform:rotate(360deg); } }

    @media (max-width:768px){
      .control-btn{ font-size:13px; padding:9px 12px; }
      .marker .label{ font-size:10px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://zqaoxvxuznonytzibhhe.supabase.co/storage/v1/object/sign/imagens_gamalaser/LOGO-GAMA-LASER.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xYjVlYTRkMi03MGI2LTQ1MjgtODE0Mi1kZDUyYmZjZTM2ZTUiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJpbWFnZW5zX2dhbWFsYXNlci9MT0dPLUdBTUEtTEFTRVIucG5nIiwiaWF0IjoxNzYwMTM3NzE5LCJleHAiOjIwNzU0OTc3MTl9.HYRTr9yYjrRMoWLZKmefCOKOfHjdXXj6z26QL7rshKc" alt="Gama Laser" />
  </div>

  <div class="container">
    <div id="loading-screen" class="loading-screen">
      <h2>Carregando seus produtos...</h2>
      <div class="spinner"></div>
    </div>

    <div class="card" id="main-card" style="display:none;">
      <h1 class="card-title">üé® Aprovar Design de Grava√ß√£o</h1>
      <p class="card-subtitle">Personalize cada produto e aprove o design final</p>

      <div class="pedido-info">
        <strong>üì¶ Pedido: #<span id="order-number">...</span></strong>
      </div>

      <div class="progress-bar" id="progress-bar"></div>

      <div class="produto-info">
        <div class="produto-counter" id="produto-counter">Produto 1 de 1</div>
        <div class="produto-detail"><strong>üì¶ Produto:</strong><span id="produto-nome">...</span></div>
        <div class="produto-detail"><strong>üé® Variante:</strong><span id="produto-variante">...</span></div>
        <div class="produto-detail"><strong>üîñ SKU:</strong><span id="produto-sku">...</span></div>
        <div class="produto-detail"><strong>üìä Quantidade:</strong><span id="produto-quantidade">...</span> unidades</div>
      </div>

      <div id="form-section">
        <div class="form-group">
          <label>üìÅ Envie seu Logo:</label>
          <input type="file" id="logo" accept="image/*" />
        </div>

        <div class="form-group">
          <label>üìù Texto para grava√ß√£o (m√°x. 20 caracteres):</label>
          <input type="text" id="texto" maxlength="20" placeholder="Digite o texto aqui" />
        </div>

        <div class="form-group">
          <label>üî§ Escolha a fonte:</label>
          <select id="fonte">
            <option>Arial</option>
            <option>Helvetica</option>
            <option>Times</option>
            <option>Verdana</option>
            <option>Courier</option>
            <option>Impact</option>
            <option>Georgia</option>
          </select>
        </div>

        <button class="btn btn-primary" onclick="gerarPrevia()">üîç Gerar Pr√©via</button>
      </div>

      <div class="preview-area" id="preview-area">
        <h3>Pr√©via do Design:</h3>

        <div class="loading-bar" id="loading-bar">
          <div class="loading-progress" id="loading-progress"></div>
          <span class="loading-text" id="loading-text">0%</span>
        </div>

        <div class="instructions">
          <strong>Como ajustar:</strong>
          üñ±Ô∏è Desktop: arraste os **ret√¢ngulos** (logo/ texto). Use os **4 cantos** para redimensionar.<br/>
          üëÜ Mobile: arraste com o dedo. **Belisque** os cantos para redimensionar.<br/>
          üîÑ Rotacione a logo em 90¬∞ e ative **Texto Vertical** se precisar.
        </div>

        <div id="stage" class="stage">
          <img id="preview-img" alt="Pr√©via" />
          <!-- Marcador LOGO -->
          <div id="logo-marker" class="marker logo" style="display:none;">
            <div class="label">üì∑ LOGO</div>
            <div class="handle tl"></div><div class="handle tr"></div>
            <div class="handle bl"></div><div class="handle br"></div>
          </div>
          <!-- Marcador TEXTO -->
          <div id="texto-marker" class="marker text" style="display:none;">
            <div class="label">‚úèÔ∏è TEXTO</div>
            <div class="handle tl"></div><div class="handle tr"></div>
            <div class="handle bl"></div><div class="handle br"></div>
          </div>
        </div>

        <div class="coords" id="coords">
          <div><strong>üìç Coordenadas:</strong></div>
          <div>Logo ‚Äî X:<span id="c-lx">0</span> Y:<span id="c-ly">0</span> W:<span id="c-lw">0</span> Rot:<span id="c-lr">0</span>¬∞</div>
          <div>Texto ‚Äî X:<span id="c-tx">0</span> Y:<span id="c-ty">0</span> W:<span id="c-tw">0</span> Rot:<span id="c-tr">0</span>¬∞</div>
        </div>

        <div class="panel" id="panel">
          <button class="control-btn btn-rotate mini" onclick="rotacionarLogo()">üîÑ Rotacionar Logo 90¬∞</button>
          <button class="control-btn btn-verttext mini" onclick="toggleTextoVertical()">‚ÜïÔ∏è Texto Vertical</button>
          <button class="control-btn btn-reset mini" onclick="resetar()">‚Ü∫ Resetar</button>
        </div>

        <button class="btn btn-success" id="btn-aprovar" onclick="aprovarProduto()">‚úÖ APROVAR ESTE PRODUTO</button>
      </div>

      <div class="error" id="error"></div>
    </div>

    <div class="success" id="success">
      <h2>üéâ Todos os Produtos Aprovados!</h2>
      <p>Obrigado! Seu pedido est√° completo e seguir√° para produ√ß√£o.</p>
      <p>Voc√™ pode fechar esta p√°gina.</p>
    </div>
  </div>

  <script>
    /* =================== CONFIG =================== */
    const CLOUD_NAME = 'dslzqtajk';
    const WEBHOOK_PREVIEW    = 'https://gama-laser-n8n.gtyipj.easypanel.host/webhook-test/gerar-preview-mockup';
    const WEBHOOK_APROVACAO  = 'https://gama-laser-n8n.gtyipj.easypanel.host/webhook-test/aprovar-mockup';
    const SUPABASE_URL       = 'https://zqaoxvxuznonytzibhhe.supabase.co';
    const SUPABASE_ANON_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxYW94dnh1em5vbnl0emliaGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDYwMTEsImV4cCI6MjA3NTEyMjAxMX0.anrCkp8mdxVPg1lpCqvnz_OxLk3ljNz1veTMPWSjtpI';

    /* =================== STATE =================== */
    let linkId = '';
    let orderNumber = '';
    let produtos = [];
    let produtoAtualIndex = 0;

    // Cloudinary parts
    let mockupPublicId = '';   // com pasta (ex.: Mockup/3017d_azul) ou raiz
    let logoPublicId = '';     // overlay public_id (com ':' se houver subpasta)
    let fonte = 'Arial';
    let textoConteudo = '';
    let temTexto = false;

    // geometry em px relativos ao asset original (naturalWidth/Height)
    let imgNaturalW = 1000; // fallback
    let imgNaturalH = 1000; // fallback
    let logoX = 0, logoY = 400, logoW = 100, logoRot = 0;
    let textoX = 0, textoY = 520, textoW = 50, textoRot = 0; // textoRot 0|90

    // drag/resize
    let dragTarget = null;      // 'logo' | 'texto'
    let resizing = false;
    let resizeCorner = null;    // 'tl'|'tr'|'bl'|'br'
    let startClientX = 0, startClientY = 0;
    let startX = 0, startY = 0, startW = 0;

    /* =================== HELPERS =================== */
    function show(id, on=true){ document.getElementById(id).style.display = on ? 'block' : 'none'; }
    function setText(id, v){ document.getElementById(id).textContent = v; }
    function err(msg){ const e=document.getElementById('error'); e.textContent=msg; e.style.display='block'; setTimeout(()=>e.style.display='none', 6000); }

    function atualizarCoordsUI(){
      setText('c-lx', logoX); setText('c-ly', logoY); setText('c-lw', logoW); setText('c-lr', logoRot);
      setText('c-tx', textoX); setText('c-ty', textoY); setText('c-tw', textoW); setText('c-tr', textoRot);
    }

    // Extrai o public_id do mockup preservando a pasta (ap√≥s o √∫ltimo /fl_layer_apply/)
    function extractMockupPublicId(url){
      const afterUpload = url.split('/upload/')[1] || '';
      const lastApply = afterUpload.lastIndexOf('/fl_layer_apply/');
      if (lastApply !== -1) return afterUpload.substring(lastApply + '/fl_layer_apply/'.length);
      // fallback: pega o trecho ap√≥s a primeira '/' (primeiro bloco de transforma√ß√£o)
      const firstSlash = afterUpload.indexOf('/');
      return firstSlash >= 0 ? afterUpload.substring(firstSlash + 1) : afterUpload;
    }

    function extractLogoPublicId(url){
      const m = url.match(/l_([^,]+)/);
      if (!m) return '';
      // Cloudinary exige ":" no lugar de "/" quando usamos l_ com subpastas
      return m[1].replaceAll('/', ':');
    }

    function extractNum(pattern, url){
      const m = url.match(pattern);
      return m ? parseInt(m[1], 10) : null;
    }

    function extractXYs(url){
      const ys = [...url.matchAll(/,y_(\d+),/g)].map(m => parseInt(m[1],10));
      const xs = [...url.matchAll(/,x_(\d+),/g)].map(m => parseInt(m[1],10));
      return { xs, ys };
    }

    /* =================== DATA LOAD =================== */
    async function carregarDados(){
      const params = new URLSearchParams(window.location.search);
      linkId = params.get('p');
      if (!linkId){ err('Link inv√°lido. Use ?p=SEU_LINK_ID'); return; }

      try{
        const r = await fetch(`${SUPABASE_URL}/rest/v1/links_aprovacao?id=eq.${linkId}&select=*`, {
          headers:{ 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
        });
        const data = await r.json();
        if (!data || !data.length){ err('Link n√£o encontrado.'); return; }

        orderNumber = data[0].order_number || '';
        produtos = typeof data[0].produtos === 'string' ? JSON.parse(data[0].produtos) : (data[0].produtos || []);

        show('loading-screen', false);
        show('main-card', true);
        document.getElementById('order-number').textContent = orderNumber;

        const progress = document.getElementById('progress-bar'); progress.innerHTML='';
        produtos.forEach((_,i)=>{ const d=document.createElement('div'); d.className='progress-dot'; d.id=`dot-${i}`; progress.appendChild(d); });

        carregarProduto(0);
      }catch(e){ console.error(e); err('Erro ao carregar dados: '+e.message); }
    }

    function carregarProduto(i){
      produtoAtualIndex = i;
      const p = produtos[i];

      document.getElementById('produto-counter').textContent = `Produto ${i+1} de ${produtos.length}`;
      document.getElementById('produto-nome').textContent = p?.nome || '-';
      document.getElementById('produto-variante').textContent = p?.variante || '-';
      document.getElementById('produto-sku').textContent = p?.sku || '-';
      document.getElementById('produto-quantidade').textContent = p?.quantidade ?? '-';

      document.querySelectorAll('.progress-dot').forEach((dot, idx)=>{
        dot.classList.remove('active','completed');
        if (idx < i) dot.classList.add('completed');
        if (idx === i) dot.classList.add('active');
      });

      document.getElementById('logo').value='';
      document.getElementById('texto').value='';
      document.getElementById('fonte').value='Arial';

      show('preview-area', false);
      show('panel', false);
      show('coords', false);
      show('stage', false);
    }

    /* =================== PREVIEW =================== */
    async function gerarPrevia(){
      const logoInput = document.getElementById('logo');
      const texto = document.getElementById('texto').value || '';
      const fonteSel = document.getElementById('fonte').value || 'Arial';
      const p = produtos[produtoAtualIndex];

      if (!logoInput.files.length){ err('Envie um logo primeiro.'); return; }

      fonte = fonteSel;
      textoConteudo = texto;
      temTexto = texto.trim().length > 0;

      show('preview-area', true);
      show('loading-bar', true);
      const lp = document.getElementById('loading-progress');
      const lt = document.getElementById('loading-text');
      lp.style.width='0%'; lt.textContent='0%';

      let prog=0; const iv=setInterval(()=>{ if(prog<90){ prog+=1; lp.style.width=`${prog}%`; lt.textContent=`${prog}%`; } }, 80);

      try{
        const fd = new FormData();
        fd.append('logo', logoInput.files[0]);
        fd.append('texto', textoConteudo);
        fd.append('fonte', fonte);
        fd.append('sku', p.sku);
        fd.append('cor', p.variante);

        const resp = await fetch(WEBHOOK_PREVIEW, { method:'POST', body:fd });
        const data = await resp.json();

        clearInterval(iv);
        lp.style.width='100%'; lt.textContent='100%'; setTimeout(()=>show('loading-bar', false), 400);

        if (!data?.preview_url){ err('Erro ao gerar pr√©via.'); return; }
        inicializarPreview(data.preview_url);
      }catch(e){
        clearInterval(iv); show('loading-bar', false); console.error(e); err('Falha na conex√£o do preview.');
      }
    }

    function inicializarPreview(url){
      // 1) Extrair partes Cloudinary
      mockupPublicId = extractMockupPublicId(url);
      logoPublicId   = extractLogoPublicId(url);

      // 2) Extrair XY/W padr√£o
      const { xs, ys } = extractXYs(url);
      if (ys[0] != null) logoY = ys[0];
      if (ys[1] != null) textoY = ys[1];
      if (xs[0] != null) logoX = xs[0];
      if (xs[1] != null) textoX = xs[1];

      const wLogo = extractNum(/,w_(\d+),/, url);
      if (wLogo != null) logoW = wLogo;

      const wText = extractNum(/l_text:[^_]+_(\d+):/, url);
      if (wText != null) textoW = wText;

      const fontM = url.match(/l_text:([^_]+)_/);
      if (fontM) fonte = fontM[1];

      const txtM = url.match(/l_text:[^:]+:([^,]+)/);
      textoConteudo = txtM ? decodeURIComponent(txtM[1]) : '';
      temTexto = !!textoConteudo;

      // 3) Montar e exibir imagem
      const img = document.getElementById('preview-img');
      img.onload = () => {
        imgNaturalW = img.naturalWidth || 1000;
        imgNaturalH = img.naturalHeight || 1000;
        prepararMarcadores();
      };
      img.src = url;

      const stage = document.getElementById('stage');
      stage.style.aspectRatio = (imgNaturalW / imgNaturalH) || '1/1';

      show('stage', true);
      show('panel', true);
      show('coords', true);
      atualizarCoordsUI();
      atualizarPreview(); // garante URL consistente
    }

    function construirURL(){
      // bloco LOGO
      const logoBlock = [
        `l_${logoPublicId}`,      // com ':' quando for subpasta
        'e_bgremoval',
        `w_${logoW}`,
        'g_north_west',
        `x_${logoX}`,
        `y_${logoY}`,
        (logoRot ? `a_${logoRot}` : null),
        'fl_layer_apply'
      ].filter(Boolean).join(',');

      let url = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${logoBlock}`;

      if (temTexto && textoConteudo){
        const tEnc = encodeURIComponent(textoConteudo);
        const textBlock = [
          `l_text:${fonte}_${textoW}:${tEnc}`,
          'co_rgb:000000',
          'g_north_west',
          `x_${textoX}`,
          `y_${textoY}`,
          (textoRot ? `a_${textoRot}` : null),
          'fl_layer_apply'
        ].filter(Boolean).join(',');
        url += `/${textBlock}`;
      }

      // PRESERVA pasta do mockup (ex.: "Mockup/3017d_azul" ou "Logos/... " ou raiz)
      url += `/${mockupPublicId}`;
      return url;
    }

    function atualizarPreview(){
      const img = document.getElementById('preview-img');
      img.src = construirURL();
      atualizarCoordsUI();
      // reposiciona marcadores conforme escala atual da imagem na tela
      posicionarMarcadores();
    }

    /* =================== MARKERS / DRAG / RESIZE =================== */
    function prepararMarcadores(){
      const logoM  = document.getElementById('logo-marker');
      const textoM = document.getElementById('texto-marker');
      logoM.style.display = 'block';
      textoM.style.display = temTexto ? 'block' : 'none';
      posicionarMarcadores();
      bindMarker(logoM, 'logo');
      if (temTexto) bindMarker(textoM, 'texto');
    }

    function getScale(){
      const img = document.getElementById('preview-img');
      const rect = img.getBoundingClientRect();
      const scaleX = rect.width / imgNaturalW;
      const scaleY = rect.height / imgNaturalH;
      return { scaleX, scaleY, rect };
    }

    function posicionarMarcadores(){
      const { scaleX, scaleY, rect } = getScale();
      const stage = document.getElementById('stage');
      const stageRect = stage.getBoundingClientRect();

      // LOGO marker: usa propor√ß√£o W e assume H ~ 0.6*W apenas para caixa visual (n√£o influencia Cloudinary)
      const logoM = document.getElementById('logo-marker');
      const logoDispW = Math.max(logoW * scaleX, 28);
      const logoDispH = Math.max(logoW * 0.6 * scaleY, 20);
      logoM.style.width  = `${logoDispW}px`;
      logoM.style.height = `${logoDispH}px`;
      logoM.style.left   = `${(rect.left - stageRect.left) + logoX * scaleX}px`;
      logoM.style.top    = `${(rect.top  - stageRect.top ) + logoY * scaleY}px`;

      // TEXTO marker
      const textoM = document.getElementById('texto-marker');
      if (temTexto){
        const textoDispW = Math.max(textoW * 3 * scaleX, 40); // caixa visual mais larga p/ texto
        const textoDispH = Math.max(textoW * 1.2 * scaleY, 18);
        textoM.style.width  = `${textoDispW}px`;
        textoM.style.height = `${textoDispH}px`;
        textoM.style.left   = `${(rect.left - stageRect.left) + textoX * scaleX}px`;
        textoM.style.top    = `${(rect.top  - stageRect.top ) + textoY * scaleY}px`;
      }
    }

    function bindMarker(el, kind){
      // drag start
      const start = (cx, cy) => {
        dragTarget = kind;
        resizing = false;
        startClientX = cx; startClientY = cy;
        startX = (kind==='logo') ? logoX : textoX;
        startY = (kind==='logo') ? logoY : textoY;
        startW = (kind==='logo') ? logoW : textoW;
      };

      el.addEventListener('mousedown', e => {
        if (e.target.classList.contains('handle')) return; // resize usa outro flow
        e.preventDefault(); start(e.clientX, e.clientY);
      }, {passive:false});
      el.addEventListener('touchstart', e => {
        if (e.target.classList.contains('handle')) return;
        const t=e.touches[0]; start(t.clientX, t.clientY);
      }, {passive:false});

      // handles
      el.querySelectorAll('.handle').forEach(h=>{
        h.addEventListener('mousedown', e=>{
          e.stopPropagation(); e.preventDefault();
          resizing = true; resizeCorner = [...h.classList].find(c=>['tl','tr','bl','br'].includes(c));
          start(e.clientX, e.clientY);
        }, {passive:false});
        h.addEventListener('touchstart', e=>{
          e.stopPropagation();
          const t=e.touches[0]; resizing=true; resizeCorner=[...h.classList].find(c=>['tl','tr','bl','br'].includes(c));
          start(t.clientX, t.clientY);
        }, {passive:false});
      });
    }

    function onMove(cx, cy){
      if (!dragTarget) return;
      const { scaleX, scaleY } = getScale();
      const dX = (cx - startClientX) / scaleX;
      const dY = (cy - startClientY) / scaleY;

      if (!resizing){
        if (dragTarget==='logo'){ logoX = Math.max(0, Math.round(startX + dX)); logoY = Math.max(0, Math.round(startY + dY)); }
        else { textoX = Math.max(0, Math.round(startX + dX)); textoY = Math.max(0, Math.round(startY + dY)); }
      } else {
        // redimensiona pela largura (W). DeltaX influencia W
        const mult = (resizeCorner==='tl' || resizeCorner==='bl') ? -1 : 1;
        const newW = Math.max(10, Math.round(startW + mult * dX));
        if (dragTarget==='logo') logoW = newW; else textoW = newW;
      }
      atualizarPreview();
    }

    function onEnd(){ dragTarget=null; resizing=false; resizeCorner=null; }

    document.addEventListener('mousemove', e => onMove(e.clientX, e.clientY));
    document.addEventListener('mouseup', onEnd);
    document.addEventListener('touchmove', e => { const t=e.touches[0]; onMove(t.clientX, t.clientY); }, {passive:false});
    document.addEventListener('touchend', onEnd);

    /* =================== CONTROLES =================== */
    function rotacionarLogo(){ logoRot = (logoRot + 90) % 360; atualizarPreview(); }
    function toggleTextoVertical(){ textoRot = (textoRot===0 ? 90 : 0); atualizarPreview(); }
    function resetar(){
      logoX=0; logoY=400; logoW=100; logoRot=0;
      textoX=0; textoY=520; textoW=50; textoRot=0;
      atualizarPreview();
    }

    /* =================== APROVAR =================== */
    async function aprovarProduto(){
      const btn = document.getElementById('btn-aprovar');
      btn.disabled = true; btn.textContent = '‚è≥ Salvando...';

      const p = produtos[produtoAtualIndex];
      const payload = {
        order_number: orderNumber,
        produto_sku: p.sku,
        produto_nome: p.nome,
        produto_variante: p.variante,
        mockup_url: construirURL(),
        logo_x: logoX, logo_y: logoY, logo_w: logoW, rotacao_logo: logoRot,
        texto_x: textoX, texto_y: textoY, texto_w: textoW, rotacao_texto: textoRot,
        timestamp: new Date().toISOString()
      };

      try{
        const r = await fetch(WEBHOOK_APROVACAO, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if (!r.ok) throw new Error('Erro ao salvar');
        document.getElementById(`dot-${produtoAtualIndex}`).classList.add('completed');

        if (produtoAtualIndex < produtos.length-1){
          setTimeout(()=>{ carregarProduto(produtoAtualIndex+1); btn.disabled=false; btn.textContent='‚úÖ APROVAR ESTE PRODUTO'; }, 800);
        } else {
          show('main-card', false);
          show('success', true);
        }
      }catch(e){
        console.error(e); err('Erro ao aprovar: '+e.message);
        btn.disabled=false; btn.textContent='‚úÖ APROVAR ESTE PRODUTO';
      }
    }

    /* =================== INIT =================== */
    window.onload = carregarDados;
  </script>
</body>
</html>
