<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aprova√ß√£o de Mockup ‚Äì Gama Laser</title>
<style>
  :root{
    --orange:#f68729; --bg:#0b0b0b; --white:#fff; --muted:#6b7280; --shadow:0 10px 30px rgba(0,0,0,.15);
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:#111; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
  .header-wrap{background:#fff; padding:22px 16px; border-bottom:3px solid var(--orange)}
  .header{max-width:1100px; margin:0 auto; text-align:center}
  .brand img{width:200px; height:auto}
  .order-info{margin-top:10px; color:var(--orange); font-weight:700}
  .order-info small{display:block; color:#c2410c; font-weight:600; opacity:.9}
  .app{max-width:1100px; margin:26px auto; padding:0 16px; display:grid; grid-template-columns:1fr 340px; gap:18px}
  @media (max-width:950px){ .app{grid-template-columns:1fr} }
  .card{background:#fff; border-radius:16px; box-shadow:var(--shadow)}
  .card.pad{padding:18px}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .muted{color:var(--muted); font-size:14px}
  /* Progress */
  .progress{display:flex; gap:10px; justify-content:center; margin-bottom:12px}
  .dot{width:10px; height:10px; border-radius:999px; background:#e5e7eb; transition:.2s}
  .dot.active{background:var(--orange); transform:scale(1.2)}
  .dot.done{background:#22c55e}
  /* Stage */
  .stage-wrap{padding:18px}
  .stage{position:relative; width:100%; background:#fafafa; border-radius:12px; overflow:hidden; box-shadow:inset 0 0 0 1px #eee}
  .stage::after{content:""; display:block; padding-top:75%} /* 4:3 default */
  .stage > img.base{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#fff}
  /* Layers (editor) */
  .layer{position:absolute; translate:-50% -50%; outline:2px dashed rgba(0,0,0,.25); border-radius:8px; user-select:none; touch-action:none}
  .layer .tag{position:absolute; top:-24px; left:0; background:#111; color:#fff; font-size:11px; font-weight:700; padding:3px 6px; border-radius:6px}
  .handles{position:absolute; inset:-8px; pointer-events:none}
  .handle{position:absolute; width:12px; height:12px; border:2px solid #0ea5e9; background:#fff; border-radius:2px; pointer-events:auto; cursor:nwse-resize}
  .handle.tl{left:-6px; top:-6px}
  .handle.br{right:-6px; bottom:-6px}
  .text-box{display:flex; align-items:center; justify-content:center; padding:6px 8px; line-height:1; white-space:pre; color:#000; transform-origin:center}
  .text-vertical{writing-mode:vertical-rl}
  .logo-box img{display:block; width:100%; height:100%; object-fit:contain; pointer-events:none}
  /* Side panel */
  .panel .section{padding:14px; border-bottom:1px solid #eee}
  .panel .section:last-child{border-bottom:0}
  .panel h3{margin:0 0 8px; font-size:16px}
  label{font-size:13px; font-weight:600; color:#111; margin-bottom:6px; display:block}
  input[type="text"], select{width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; font-size:14px}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; width:100%; border:0; border-radius:10px; padding:12px; font-weight:800; cursor:pointer}
  .btn.primary{background:var(--orange); color:#fff}
  .btn.dark{background:#111; color:#fff}
  .btn.gray{background:#e5e7eb}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  .coords{font-family:ui-monospace,Menlo,Consolas,monospace; background:#0f172a; color:#93c5fd; padding:10px 12px; border-radius:10px; font-size:12px; white-space:pre-wrap}
  .error{background:#fee2e2; border:1px solid #ef4444; color:#991b1b; padding:10px 12px; border-radius:10px; display:none}
  .success{background:#ecfdf5; border:1px solid #10b981; color:#065f46; padding:12px; border-radius:10px; display:none}
  .hide{display:none!important}
</style>
</head>
<body>

  <!-- HEADER -->
  <div class="header-wrap">
    <div class="header">
      <div class="brand">
        <img src="https://zqaoxvxuznonytzibhhe.supabase.co/storage/v1/object/sign/imagens_gamalaser/LOGO-GAMA-LASER.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xYjVlYTRkMi03MGI2LTQ1MjgtODE0Mi1kZDUyYmZjZTM2ZTUiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJpbWFnZW5zX2dhbWFsYXNlci9MT0dPLUdBTUEtTEFTRVIucG5nIiwiaWF0IjoxNzYwMTM3NzE5LCJleHAiOjIwNzU0OTc3MTl9.HYRTr9yYjrRMoWLZKmefCOKOfHjdXXj6z26QL7rshKc" alt="Gama Laser" />
      </div>
      <div class="order-info">
        <div id="orderLine">Pedido #‚Äî</div>
        <small id="orderSub">Produto ‚Äî SKU ‚Äî</small>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app">
    <!-- LEFT: Editor -->
    <div class="card stage-wrap">
      <!-- Loading / mensagens -->
      <div id="msgError" class="error">Erro‚Ä¶</div>
      <div id="msgOk" class="success">OK</div>

      <!-- Progress dos produtos -->
      <div id="progress" class="progress"></div>

      <!-- Painel de dados do produto atual -->
      <div class="row" style="justify-content:space-between; align-items:center; margin:8px 0 14px">
        <div class="muted">
          <strong>Produto atual:</strong> <span id="pNome">‚Äî</span> ¬∑
          <strong>Variante:</strong> <span id="pVariante">‚Äî</span> ¬∑
          <strong>SKU:</strong> <span id="pSku">‚Äî</span> ¬∑
          <strong>Qtd:</strong> <span id="pQtd">‚Äî</span>
        </div>
      </div>

      <!-- Stage (mockup base + layers edit√°veis) -->
      <div id="stage" class="stage">
        <img id="baseImg" class="base" alt="mockup" />
        <!-- Texto -->
        <div id="textLayer" class="layer hide" data-type="text">
          <div class="tag">‚úèÔ∏è TEXTO</div>
          <div id="textBox" class="text-box">Seu texto</div>
          <div class="handles">
            <div class="handle tl" data-resize="tl"></div>
            <div class="handle br" data-resize="br"></div>
          </div>
        </div>
        <!-- Logo -->
        <div id="logoLayer" class="layer hide" data-type="logo" style="width:110px; height:110px;">
          <div class="tag">üì∑ LOGO</div>
          <div class="logo-box"><img id="logoImg" alt="logo" /></div>
          <div class="handles">
            <div class="handle tl" data-resize="tl"></div>
            <div class="handle br" data-resize="br"></div>
          </div>
        </div>
      </div>

      <!-- Coordenadas -->
      <div id="coords" class="coords" style="margin-top:12px">‚Äî</div>
    </div>

    <!-- RIGHT: Painel -->
    <div class="card panel">
      <!-- Entrada -->
      <div class="section">
        <h3>1) Selecione e gere a pr√©via</h3>
        <label>Logo (arquivo)</label>
        <input id="logoInput" type="file" accept="image/*" />
        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Texto (20 caract.)</label>
            <input id="textInput" type="text" maxlength="20" placeholder="Digite o texto‚Ä¶" />
          </div>
          <div>
            <label>Fonte</label>
            <select id="fontSelect">
              <option>Arial</option><option>Helvetica</option><option>Times</option>
              <option>Verdana</option><option>Courier</option><option>Impact</option>
              <option>Georgia</option>
            </select>
          </div>
        </div>
        <button id="btnPreview" class="btn dark" style="margin-top:12px">üîç Gerar pr√©via</button>
      </div>

      <!-- Edi√ß√£o -->
      <div id="editSection" class="section hide">
        <h3>2) Ajuste livre (arraste, redimensione, gire)</h3>
        <div class="grid3" style="margin-top:8px">
          <button id="btnRotateLogo" class="btn gray">‚§¥Ô∏è Rotacionar Logo 90¬∞</button>
          <button id="btnTextVertical" class="btn gray">‚ÜïÔ∏è Texto Vertical</button>
          <button id="btnReset" class="btn gray">‚Ü∫ Resetar</button>
        </div>
        <div class="grid2" style="margin-top:8px">
          <button id="btnLogoMinus" class="btn gray">‚àí Logo</button>
          <button id="btnLogoPlus" class="btn gray">+ Logo</button>
        </div>
        <div class="grid2" style="margin-top:8px">
          <button id="btnTextMinus" class="btn gray">‚àí Texto</button>
          <button id="btnTextPlus" class="btn gray">+ Texto</button>
        </div>
      </div>

      <!-- Aprovar -->
      <div id="approveSection" class="section hide">
        <h3>3) Aprovar produto</h3>
        <p class="muted" style="margin:0 0 8px">Ao aprovar, geramos a URL final (Cloudinary) com logo e texto aplicados.</p>
        <button id="btnApprove" class="btn primary">‚úÖ Aprovar este produto</button>
      </div>
    </div>
  </div>

<script>
/* ===================== CONFIG ===================== */
const CLOUD_NAME = 'dslzqtajk';
const WEBHOOK_PREVIEW   = 'https://gama-laser-n8n.gtyipj.easypanel.host/webhook-test/gerar-preview-mockup';
const WEBHOOK_APROVACAO = 'https://gama-laser-n8n.gtyipj.easypanel.host/webhook-test/aprovar-mockup'; // usar quando integrar
const SUPABASE_URL      = 'https://zqaoxvxuznonytzibhhe.supabase.co';
const SUPABASE_KEY      = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxYW94dnh1em5vbnl0emliaGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDYwMTEsImV4cCI6MjA3NTEyMjAxMX0.anrCkp8mdxVPg1lpCqvnz_OxLk3ljNz1veTMPWSjtpI';

/* ===================== STATE ===================== */
let linkId = '';
let orderNumber = '';
let produtos = [];
let idxAtual = 0;

let mockupPublicId = '';  // ex.: "mockups/3017d_azul"
let logoPublicId   = '';  // ex.: "logo_3017D_1760..."
let fonte = 'Arial';
let texto = '';
let hasText = false;

// geometria relativa ao STAGE (percentuais atrav√©s do centro)
const state = {
  logo: { x: 0.30, y: 0.30, w: 120, rot: 0 },
  text: { x: 0.55, y: 0.30, font: 28, rot: 0, vertical: false }
};

/* ===================== ELTs ===================== */
const msgError = document.getElementById('msgError');
const msgOk    = document.getElementById('msgOk');

const orderLine = document.getElementById('orderLine');
const orderSub  = document.getElementById('orderSub');

const progress  = document.getElementById('progress');
const pNome = document.getElementById('pNome');
const pVar  = document.getElementById('pVariante');
const pSku  = document.getElementById('pSku');
const pQtd  = document.getElementById('pQtd');

const stage = document.getElementById('stage');
const baseImg = document.getElementById('baseImg');
const textLayer = document.getElementById('textLayer');
const textBox   = document.getElementById('textBox');
const logoLayer = document.getElementById('logoLayer');
const logoImg   = document.getElementById('logoImg');
const coords    = document.getElementById('coords');

const logoInput = document.getElementById('logoInput');
const textInput = document.getElementById('textInput');
const fontSelect= document.getElementById('fontSelect');
const btnPreview= document.getElementById('btnPreview');

const editSection    = document.getElementById('editSection');
const approveSection = document.getElementById('approveSection');

const btnRotateLogo  = document.getElementById('btnRotateLogo');
const btnTextVertical= document.getElementById('btnTextVertical');
const btnReset       = document.getElementById('btnReset');
const btnLogoMinus   = document.getElementById('btnLogoMinus');
const btnLogoPlus    = document.getElementById('btnLogoPlus');
const btnTextMinus   = document.getElementById('btnTextMinus');
const btnTextPlus    = document.getElementById('btnTextPlus');
const btnApprove     = document.getElementById('btnApprove');

/* ===================== UTILS ===================== */
function showError(msg){ msgError.textContent = msg; msgError.style.display = 'block'; setTimeout(()=>msgError.style.display='none', 6000); }
function showOk(msg){ msgOk.textContent = msg; msgOk.style.display='block'; setTimeout(()=>msgOk.style.display='none', 2000); }
function setHidden(el, cond){ el.classList.toggle('hide', cond); }
const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
const px = n => `${Math.round(n)}px`;

/* ===================== SUPABASE LOAD ===================== */
async function carregarPedido(){
  const params = new URLSearchParams(location.search);
  linkId = params.get('p') || '';
  if(!linkId){ showError('Link inv√°lido. Use ?p=SEU_LINK_ID'); return; }

  try{
    const r = await fetch(`${SUPABASE_URL}/rest/v1/links_aprovacao?id=eq.${linkId}&select=*`,{
      headers:{ 'apikey':SUPABASE_KEY, 'Authorization':`Bearer ${SUPABASE_KEY}` }
    });
    const data = await r.json();
    if(!data?.length){ showError('Link n√£o encontrado.'); return; }

    const row = data[0];
    orderNumber = row.order_number ?? row.order_id ?? '';
    const arr = typeof row.produtos === 'string' ? JSON.parse(row.produtos) : row.produtos;
    produtos = Array.isArray(arr) ? arr : [];
    if(!produtos.length){ showError('Nenhum produto neste link.'); return; }

    orderLine.textContent = `Pedido #${orderNumber}`;
    loadProduto(0);
    // progress
    progress.innerHTML = '';
    produtos.forEach((_,i)=>{
      const d = document.createElement('div'); d.className='dot'+(i===0?' active':''); d.id=`dot-${i}`; progress.appendChild(d);
    });
  }catch(e){
    console.error(e); showError('Erro ao carregar pedido: '+e.message);
  }
}

function loadProduto(idx){
  idxAtual = idx;
  const p = produtos[idx];
  pNome.textContent = p?.nome || '-';
  pVar .textContent = p?.variante || '-';
  pSku .textContent = p?.sku || '-';
  pQtd .textContent = p?.quantidade ?? '-';
  orderSub.textContent = `${p?.nome || '-'} ‚Äî SKU ${p?.sku || '-'}`;

  // Reset editor state
  mockupPublicId = '';
  logoPublicId   = '';
  fonte = 'Arial'; texto = ''; hasText = false;
  state.logo = { x:0.30,y:0.30,w:120, rot:0 };
  state.text = { x:0.55,y:0.30,font:28, rot:0, vertical:false };

  baseImg.removeAttribute('src');
  logoImg.removeAttribute('src');
  setHidden(textLayer,true);
  setHidden(logoLayer,true);
  setHidden(editSection,true);
  setHidden(approveSection,true);

  // marcar progresso
  document.querySelectorAll('.dot').forEach((el,i)=>{
    el.classList.remove('active');
    if(i<idx) el.classList.add('done');
  });
  const cur = document.getElementById(`dot-${idx}`);
  cur?.classList.add('active');
}

/* ===================== PREVIEW (via n8n) ===================== */
btnPreview.addEventListener('click', async ()=>{
  const p = produtos[idxAtual];
  const file = logoInput.files?.[0];
  if(!file){ showError('Envie um arquivo de logo.'); return; }

  texto = (textInput.value || '').trim();
  fonte = fontSelect.value || 'Arial';
  hasText = texto.length>0;

  try{
    const fd = new FormData();
    fd.append('logo', file);
    fd.append('texto', texto);
    fd.append('fonte', fonte);
    fd.append('sku', p.sku);
    fd.append('cor', p.variante);

    const resp = await fetch(WEBHOOK_PREVIEW,{method:'POST', body:fd});
    const data = await resp.json();

    if(!data?.preview_url){ showError('Erro ao gerar pr√©via.'); return; }

    // Extrair mockup public_id (apenas o caminho final)
    mockupPublicId = extractMockupId(data.preview_url);
    // Extrair logo public_id (l_‚Ä¶ -> respeitando subpasta se existir)
    logoPublicId   = extractLogoPublicId(data.preview_url);

    // Mostrar mockup LIMPO
    baseImg.src = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${encodeURIComponent(mockupPublicId)}`;
    // Mostrar logo SEM FUNDO no editor
    logoImg.src = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/e_bgremoval/${encodeURIComponent(logoPublicId)}.png`;

    // Preparar camadas
    textBox.textContent = texto || '';
    state.text.vertical = false; state.text.rot = 0;
    applyPositions();

    setHidden(textLayer, !hasText);
    setHidden(logoLayer, false);
    setHidden(editSection,false);
    setHidden(approveSection,false);
    showOk('Pr√©via pronta. Ajuste livremente.');
  }catch(e){
    console.error(e); showError('Falha na conex√£o: '+e.message);
  }
});

function extractMockupId(url){
  // trecho ap√≥s /upload/ e depois do √∫ltimo '/fl_layer_apply/'
  const after = url.split('/upload/')[1] || '';
  const last = after.lastIndexOf('/fl_layer_apply/');
  if(last!==-1) return decodeURIComponent(after.substring(last + '/fl_layer_apply/'.length));
  // fallback: pega o que vem ap√≥s a primeira ‚Äú/‚Äù
  const i = after.indexOf('/');
  return decodeURIComponent(i>=0 ? after.substring(i+1) : after);
}
function extractLogoPublicId(url){
  const m = url.match(/l_([^,]+)/);
  if(!m) return '';
  return decodeURIComponent(m[1]).replaceAll('/',':'); // Cloudinary overlay usa ":" para subpasta
}

/* ===================== EDITOR ===================== */
function stageRect(){ return stage.getBoundingClientRect(); }
function applyPositions(){
  // Texto
  textBox.style.fontSize = px(state.text.font);
  textBox.classList.toggle('text-vertical', state.text.vertical);
  const txtRot = `rotate(${state.text.rot}deg)`;
  textBox.style.transform = txtRot;
  textLayer.style.left = `${state.text.x*100}%`;
  textLayer.style.top  = `${state.text.y*100}%`;
  // Recalcular bounding do texto (para o ‚Äúquadrado‚Äù acompanhar rota√ß√£o)
  requestAnimationFrame(()=>{
    const b = textBox.getBoundingClientRect();
    const w = Math.max(30, b.width);
    const h = Math.max(24, b.height);
    textLayer.style.width  = px(w);
    textLayer.style.height = px(h);
    updateCoords();
  });

  // Logo
  logoLayer.style.left = `${state.logo.x*100}%`;
  logoLayer.style.top  = `${state.logo.y*100}%`;
  logoLayer.style.width  = px(state.logo.w);
  logoLayer.style.height = px(state.logo.w); // propor√ß√£o 1:1
  logoLayer.style.transform = `translate(-50%,-50%) rotate(${state.logo.rot}deg)`;
  updateCoords();
}

function updateCoords(){
  const r = stageRect();
  const lx = Math.round(state.logo.x * r.width);
  const ly = Math.round(state.logo.y * r.height);
  const tx = Math.round(state.text.x * r.width);
  const ty = Math.round(state.text.y * r.height);
  coords.textContent =
`üìç Coordenadas
Logo  ‚Äî X:${lx} Y:${ly} W:${state.logo.w} Rot:${state.logo.rot}¬∞
Texto ‚Äî X:${tx} Y:${ty} Font:${state.text.font} Rot:${state.text.rot}¬∞ ${state.text.vertical?'(vertical)':''}`;
}

/* Drag & Resize independentes */
function initLayerDrag(layer, kind){
  let dragging=false, resizing=false, start={};
  let rectS, stageR;

  const onPointerDown = (e)=>{
    const isHandle = e.target.classList.contains('handle');
    dragging = !isHandle;
    resizing = isHandle ? e.target.dataset.resize : false;
    rectS = layer.getBoundingClientRect();
    stageR = stageRect();
    start = { x:(e.clientX ?? e.touches?.[0]?.clientX), y:(e.clientY ?? e.touches?.[0]?.clientY) };
    document.addEventListener('pointermove', onPointerMove);
    document.addEventListener('pointerup', onPointerUp, {once:true});
  };
  const onPointerMove = (e)=>{
    const cx = e.clientX ?? e.touches?.[0]?.clientX;
    const cy = e.clientY ?? e.touches?.[0]?.clientY;
    const dx = cx - start.x;
    const dy = cy - start.y;

    if(dragging){
      const nx = clamp((rectS.left + dx - stageR.left + rectS.width/2) / stageR.width, 0.02, 0.98);
      const ny = clamp((rectS.top  + dy - stageR.top  + rectS.height/2) / stageR.height, 0.02, 0.98);
      if(kind==='logo'){ state.logo.x = nx; state.logo.y = ny; }
      else { state.text.x = nx; state.text.y = ny; }
      applyPositions();
    }
    if(resizing){
      // usamos apenas o canto BR/TL para varia√ß√£o de tamanho (escala)
      const factor = (rectS.width + dx * (resizing==='br'?1:-1)) / rectS.width;
      if(kind==='logo'){
        state.logo.w = Math.max(24, Math.round(state.logo.w * factor));
      }else{
        state.text.font = Math.max(8, Math.round(state.text.font * factor));
      }
      applyPositions();
      start.x = cx; start.y = cy; rectS = layer.getBoundingClientRect(); // incremental suave
    }
  };
  const onPointerUp = ()=>{ dragging=false; resizing=false; document.removeEventListener('pointermove', onPointerMove); };

  layer.addEventListener('pointerdown', (e)=>{ e.stopPropagation(); onPointerDown(e); });
}
initLayerDrag(logoLayer, 'logo');
initLayerDrag(textLayer, 'text');

/* Bot√µes de edi√ß√£o */
btnRotateLogo.addEventListener('click', ()=>{ state.logo.rot = (state.logo.rot+90)%360; applyPositions(); });
btnTextVertical.addEventListener('click', ()=>{ state.text.vertical = !state.text.vertical; applyPositions(); });
btnReset.addEventListener('click', ()=>{
  state.logo = { x:0.30, y:0.30, w:120, rot:0 };
  state.text = { x:0.55, y:0.30, font:28, rot:0, vertical:false };
  applyPositions();
});
btnLogoMinus.addEventListener('click', ()=>{ state.logo.w = Math.max(24, state.logo.w-6); applyPositions(); });
btnLogoPlus .addEventListener('click', ()=>{ state.logo.w = Math.min(900, state.logo.w+6); applyPositions(); });
btnTextMinus.addEventListener('click', ()=>{ state.text.font = Math.max(8, state.text.font-2); applyPositions(); });
btnTextPlus .addEventListener('click', ()=>{ state.text.font = Math.min(240, state.text.font+2); applyPositions(); });

/* Inputs */
textInput.addEventListener('input', ()=>{ texto = textInput.value; hasText = texto.trim().length>0; textBox.textContent = texto; setHidden(textLayer,!hasText); applyPositions(); });
fontSelect.addEventListener('change', ()=>{ fonte = fontSelect.value; /* aplicado s√≥ na URL final */ });

/* ===================== URL FINAL (Aprovar) ===================== */
btnApprove.addEventListener('click', async ()=>{
  if(!mockupPublicId || !logoPublicId){ showError('Gere a pr√©via primeiro.'); return; }
  const r = stageRect();

  // Coordenadas absolutas (px) no canvas para Cloudinary
  const lx = Math.round(state.logo.x * r.width);
  const ly = Math.round(state.logo.y * r.height);
  const logoW = Math.round(state.logo.w);

  let url = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/`;

  // LOGO overlay (mant√©m e_bgremoval no processamento final)
  url += `l_${encodeURIComponent(logoPublicId)},e_bgremoval,w_${logoW},g_north_west,x_${lx},y_${ly}`;
  if(state.logo.rot) url += `,a_${((state.logo.rot%360)+360)%360}`;
  url += `/fl_layer_apply/`;

  // TEXT overlay (se houver)
  if(hasText && texto){
    const extraRot = state.text.vertical ? 90 : 0;
    const tRot = ((state.text.rot + extraRot)%360+360)%360;
    const tx = Math.round(state.text.x * r.width);
    const ty = Math.round(state.text.y * r.height);
    const fontPx = Math.max(8, Math.round(state.text.font));
    const safeText = texto.replace(/\//g,'\\/');

    url += `l_text:${fonte}_${fontPx}:${encodeURIComponent(safeText)},co_rgb:000000,g_north_west,x_${tx},y_${ty}`;
    if(tRot) url += `,a_${tRot}`;
    url += `/fl_layer_apply/`;
  }

  url += encodeURIComponent(mockupPublicId);

  // üëâ aqui voc√™ integra com seu webhook de aprova√ß√£o (quando o fluxo estiver pronto)
  console.log('URL FINAL:', url);
  showOk('URL final gerada (copiada no console).');
  // Exemplo de envio:
  // await fetch(WEBHOOK_APROVACAO,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ order_number: orderNumber, produto: produtos[idxAtual], url })})
});

/* ===================== BOOT ===================== */
window.addEventListener('load', carregarPedido);
</script>
</body>
</html>
