<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Aprovar Design – Gama Laser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon (Cloudinary permanente) -->
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dslzqtajk/image/upload/v1760212909/favicon_1_zwr6t2.png" />

  <style>
    :root{
      --gama-orange:#f68729;
      --bg-dark:#000;
      --panel:#fff;
      --text:#111;
      --muted:#6b7280;
      --ring:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:#000;
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
    }

    /* Header preto */
    .topbar{
      background:#000;
      color:#fff;
      border-bottom:3px solid var(--gama-orange);
    }
    .topbar-inner{
      max-width:1000px;
      margin:0 auto;
      padding:14px 18px;
      display:flex;
      align-items:center;
      gap:16px;
    }
    .topbar img.logo{
      height:44px; width:auto; display:block;
    }
    .topbar .brand{
      line-height:1.2;
    }
    .brand .title{
      font-weight:700;
      font-size:16px;
    }
    .brand .subtitle{
      font-size:12px;
      color:#e5e7eb;
    }

    /* Container / painel branco */
    .wrap{
      max-width:1000px;
      margin:24px auto 56px;
      padding:0 16px;
    }
    .panel{
      background:#fff;
      border-radius:18px;
      box-shadow:0 10px 40px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .panel-head{
      padding:18px 18px 8px;
      border-bottom:1px solid var(--ring);
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:8px 18px;
      align-items:center;
      justify-content:space-between;
    }
    .order-badge{
      color:var(--gama-orange);
      font-weight:700;
    }
    .prod-info{
      display:flex;
      flex-wrap:wrap;
      gap:14px 24px;
      color:#111;
    }
    .prod-info span b{ color:#000 }

    .panel-body{ padding:18px; }

    /* Progress de produtos */
    .dots{
      display:flex; gap:10px; margin:10px 0 18px;
      justify-content:center;
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      background:#d1d5db; transition:.2s;
    }
    .dot.active{ background:var(--gama-orange); transform:scale(1.2) }
    .dot.done{ background:#10b981 }

    /* Form */
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:14px;
    }
    .field label{
      display:block; font-weight:600; margin:6px 0 6px; color:#111;
    }
    .field input[type="file"],
    .field input[type="text"],
    .field select{
      width:100%;
      padding:12px 12px;
      border:2px solid #e5e7eb;
      border-radius:10px;
      font-size:14px;
      outline:none;
    }
    .field input:focus, .field select:focus{
      border-color:var(--gama-orange);
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; border:0; cursor:pointer; border-radius:10px;
      font-weight:700; padding:12px 16px; transition:.15s;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn-black{ background:#111; color:#fff }
    .btn-black:hover{ filter:brightness(1.05) }
    .btn-orange{ background:var(--gama-orange); color:#fff }
    .btn-orange:hover{ filter:brightness(0.95) }
    .btn-outline{
      background:#fff; color:#111; border:2px solid #e5e7eb;
    }
    .stack-8{ display:flex; gap:8px; flex-wrap:wrap }
    .stack-12{ display:flex; gap:12px; flex-wrap:wrap }

    /* Preview + ferramentas */
    .preview-block{ margin-top:12px }
    .canvas-wrap{
      position:relative; width:100%; background:#f8fafc; border:2px dashed #e5e7eb;
      border-radius:12px; overflow:hidden;
    }
    .canvas{
      width:100%; display:block; user-select:none; pointer-events:none;
    }
    .layer-box{
      position:absolute; border:2px dashed var(--gama-orange);
      background:rgba(246,135,41,.08);
      border-radius:8px; touch-action:none;
    }
    .layer-box.text{
      border-color:#38bdf8;
      background:rgba(56,189,248,.08);
    }
    .handle{
      width:12px;height:12px;border-radius:3px;background:#111;position:absolute;
    }
    .tl{ left:-6px; top:-6px } .tr{ right:-6px; top:-6px }
    .bl{ left:-6px; bottom:-6px } .br{ right:-6px; bottom:-6px }
    .badge{
      position:absolute; top:-26px; left:50%; transform:translateX(-50%);
      background:#000; color:#fff; font-weight:700; font-size:11px;
      padding:4px 8px; border-radius:6px; pointer-events:none;
      white-space:nowrap;
    }

    .tools{
      margin-top:12px; padding:12px; border:1px solid var(--ring); border-radius:12px;
      background:#fff;
    }
    .tools h4{ margin:0 0 8px; font-size:14px; color:#111 }
    .tools .group{ display:flex; flex-wrap:wrap; gap:8px }

    .err{ margin-top:12px; padding:10px 12px; border:2px solid #ef4444; color:#991b1b; border-radius:10px; display:none }

    /* Barra de progresso em modal */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:50;
    }
    .modal-card{
      width:min(92vw, 420px);
      background:#fff; border-radius:14px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.5);
      text-align:center;
    }
    .meter{
      width:100%; height:18px; background:#eef2ff; border-radius:999px; overflow:hidden; position:relative; margin-top:10px;
    }
    .meter > i{
      position:absolute; left:0; top:0; bottom:0; width:0%;
      background:linear-gradient(90deg,#f68729,#d67420);
      transition:width .3s;
    }
    .meter span{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; color:#111;
      mix-blend-mode:darken;
    }

    /* Sucesso final */
    .done{
      display:none; padding:48px 18px; text-align:center; color:#111;
    }
    .done h2{ font-size:26px; margin:0 0 10px }
    .done p{ color:#374151; margin:6px 0 }

    @media(min-width:768px){
      .grid{ grid-template-columns:1fr 1fr }
    }
  </style>
</head>
<body>
  <!-- Topo preto -->
  <header class="topbar">
    <div class="topbar-inner">
      <img class="logo" alt="Gama Laser" src="https://res.cloudinary.com/dslzqtajk/image/upload/v1760212909/LOGO-GAMA-LASER_1_sjrgzj.png" />
      <div class="brand">
        <div class="title">Gama Laser — Comunicação Visual & Atacado dos Brindes Personalizados</div>
        <div class="subtitle" id="headline-order">Pedido #—</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="panel-head">
        <div class="row">
          <div class="order-badge">Aprovação de Design</div>
          <div id="order-mini" class="prod-info">
            <span><b>Pedido:</b> <span id="order-number">—</span></span>
            <span><b>Produto:</b> <span id="produto-nome">—</span></span>
            <span><b>SKU:</b> <span id="produto-sku">—</span></span>
          </div>
        </div>
        <div class="dots" id="dots"></div>
      </div>

      <div class="panel-body">
        <!-- Form -->
        <div class="grid">
          <div class="field">
            <label>📁 Envie seu logo (PNG/JPG, fundo será removido automaticamente)</label>
            <input id="logo" type="file" accept="image/*" />
          </div>
          <div class="field">
            <label>📝 Texto para gravação (máx. 20)</label>
            <input id="texto" type="text" maxlength="20" placeholder="Digite o texto (opcional)" />
          </div>
          <div class="field">
            <label>🔤 Fonte</label>
            <select id="fonte">
              <option>Arial</option><option>Helvetica</option><option>Verdana</option>
              <option>Times</option><option>Georgia</option><option>Tahoma</option>
              <option>Courier</option><option>Impact</option>
            </select>
          </div>
          <div class="field" style="display:flex;align-items:end">
            <button class="btn btn-black" id="btn-gerar">🔍 Gerar prévia</button>
          </div>
        </div>

        <!-- Preview + ferramentas -->
        <div class="preview-block" id="preview-block" style="display:none">
          <div class="canvas-wrap" id="canvas-wrap">
            <img id="canvas" class="canvas" src="" alt="Prévia do mockup" />

            <!-- Caixa da LOGO -->
            <div id="box-logo" class="layer-box" style="display:none">
              <div class="badge">LOGO</div>
              <div class="handle tl"></div><div class="handle tr"></div>
              <div class="handle bl"></div><div class="handle br"></div>
            </div>

            <!-- Caixa do TEXTO -->
            <div id="box-texto" class="layer-box text" style="display:none">
              <div class="badge">TEXTO</div>
              <div class="handle tl"></div><div class="handle tr"></div>
              <div class="handle bl"></div><div class="handle br"></div>
            </div>
          </div>

          <!-- Ferramentas -->
          <div class="tools">
            <h4>Ajustes rápidos</h4>
            <div class="group stack-8" style="margin-bottom:8px">
              <button class="btn btn-outline" id="rot-logo">🔄 Rotacionar LOGO 90°</button>
              <button class="btn btn-outline" id="rot-texto">🔄 Rotacionar TEXTO 90°</button>
              <button class="btn btn-outline" id="reset">↺ Resetar posições</button>
            </div>
            <div class="group stack-8">
              <button class="btn btn-orange" id="aprovar">✅ Aprovar este produto</button>
            </div>
          </div>
        </div>

        <div class="err" id="err"></div>
      </div>
    </section>

    <section class="done" id="done">
      <h2>🎉 Todos os produtos foram aprovados com sucesso!</h2>
      <p>Obrigado! Vamos seguir com a produção conforme sua personalização.</p>
    </section>
  </main>

  <!-- Modal de Progresso -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <div style="font-weight:700">Gerando sua prévia…</div>
      <div class="meter" style="margin-top:10px">
        <i id="bar" style="width:0%"></i>
        <span id="pct">0%</span>
      </div>
      <div style="font-size:12px; color:#374151; margin-top:10px">
        Geraremos uma prévia de como o produto ficará após a personalização.
      </div>
    </div>
  </div>

  <script>
    /*************** CONFIG ***************/
    const WEBHOOK_PREVIEW   = 'https://gama-laser-n8n.gtyipj.easypanel.host/webhook-test/gerar-preview-mockup';
    const WEBHOOK_APROVACAO = 'https://gama-laser-n8n.gtyipj.easypanel.host/webhook/aprovar-mockup';
    const SUPABASE_URL      = 'https://zqaoxvxuznonytzibhhe.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxYW94dnh1em5vbnl0emliaGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDYwMTEsImV4cCI6MjA3NTEyMjAxMX0.anrCkp8mdxVPg1lpCqvnz_OxLk3ljNz1veTMPWSjtpI';

    /*************** STATE ***************/
    let linkId = '';                 // ?p=...
    let orderNumber = '';
    let produtos = [];               // array de produtos do link
    let idxAtual = 0;                // produto atual

    // Dados parseados do preview_url (Cloudinary)
    let cloud = '';                  // cloud name
    let baseId = '';                 // mockups/3017d_azul (public id do mockup base)
    let logoId = '';                 // l_logo_... id da camada de logo (sem "l_")
    let hasText = false;

    // Geometrias (em coordenadas do asset original)
    let logoX=0, logoY=400, logoW=100, logoRot=0;
    let txtX=0,  txtY=520,  txtW=50,   txtRot=0;
    let fonte='Arial', textoVal='';

    // Drag/resize
    let dragTarget = null; // 'logo' | 'texto' | null
    let resizing = false;
    let resizeCorner = null; // 'tl','tr','bl','br'
    let start = {x:0,y:0, w:0,h:0, X:0,Y:0};
    let natural = {w:0,h:0}; // natural image size for scale

    /*************** HELPERS ***************/
    const $ = sel => document.querySelector(sel);
    const show = (el, on=true)=> { el.style.display = on ? '' : 'none' }
    const setText = (el, t)=> { el.textContent = t }
    const err = msg => { const e=$("#err"); e.textContent=msg; e.style.display='block'; setTimeout(()=>e.style.display='none', 5000) }

    function q(url){ return fetch(url, { headers:{ 'apikey':SUPABASE_ANON_KEY, 'Authorization':`Bearer ${SUPABASE_ANON_KEY}` }}) }

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)) }

    // Constrói URL Cloudinary SEM duplicar camadas
    function buildURL(){
      if(!cloud || !baseId) return '';

      const logoParts = [`l_${logoId}`, 'e_bgremoval', `w_${Math.max(10,Math.round(logoW))}`, 'g_north_west', `x_${Math.round(logoX)}`, `y_${Math.round(logoY)}`];
      if(logoRot % 360 !== 0) logoParts.push(`a_${(logoRot%360+360)%360}`);
      logoParts.push('fl_layer_apply');

      let url = `https://res.cloudinary.com/${cloud}/image/upload/${logoParts.join(',')}`;

      if(hasText && textoVal.trim()!==''){
        const enc = encodeURIComponent(textoVal);
        const tParts = [
          `l_text:${fonte}_${Math.max(8,Math.round(txtW))}:${enc}`,
          'co_rgb:000000',
          'g_north_west',
          `x_${Math.round(txtX)}`, `y_${Math.round(txtY)}`
        ];
        if(txtRot % 360 !== 0) tParts.push(`a_${(txtRot%360+360)%360}`);
        tParts.push('fl_layer_apply');
        url += `/${tParts.join(',')}`;
      }

        // --- Garante que o mockup base sempre esteja no caminho correto (pasta Mockup)
        let path = baseId;
        if (!/^Mockup\//i.test(path)) {
          path = `Mockup/${path}`;
        }
      
        url += `/${path}`; // sempre por último: o mockup base
        return url;
      }

    // Atualiza imagem e caixas
    function refreshPreview(){
      const img = $("#canvas");
      const url = buildURL();
      if(!url) return;
      img.src = url;
      positionBoxes();
    }

    function parsePreviewURL(url){
      // cloud
      const mCloud = url.match(/res\.cloudinary\.com\/([^/]+)\/image\/upload/);
      cloud = mCloud ? mCloud[1] : '';

      // base public id (após último '/')
      baseId = url.split('/').pop() || '';

      // l_<id>
      const mLogo = url.match(/\/l_([^,\/]+)/);
      logoId = mLogo ? mLogo[1] : '';

      // x_/y_/w_ – primeira ocorrência pertence à logo
      const ys = [...url.matchAll(/,y_(\d+)/g)].map(m=>parseInt(m[1],10));
      const xs = [...url.matchAll(/,x_(\d+)/g)].map(m=>parseInt(m[1],10));
      const ws = [...url.matchAll(/,w_(\d+)/g)].map(m=>parseInt(m[1],10));

      logoY = ys[0] ?? 400;
      logoX = xs[0] ?? 0;
      logoW = ws[0] ?? 100;

      // logo rotation (a_ após x,y da logo)
      const aAll = [...url.matchAll(/,a_(\d+)/g)].map(m=>parseInt(m[1],10));
      logoRot = aAll.length ? aAll[0] : 0;

      // texto?
      const tMatch = url.match(/l_text:([^_]+)_(\d+):([^,]+)/);
      hasText = !!tMatch;
      if(hasText){
        fonte = decodeURIComponent(tMatch[1]);
        txtW = parseInt(tMatch[2],10) || 50;
        textoVal = decodeURIComponent(tMatch[3] || '');
        // texto X/Y/rot (segunda ocorrência de x_, y_, a_)
        txtY = ys[1] ?? 520;
        txtX = xs[1] ?? 0;
        txtRot = aAll[1] ?? 0;
      }else{
        txtW = 50; txtX=0; txtY=520; txtRot=0; textoVal = ($("#texto").value||'');
      }
    }

    // Posiciona as caixas em coordenadas de tela (convertendo da resolução original)
    function positionBoxes(){
      const img = $("#canvas");
      if(!img.naturalWidth || !img.naturalHeight) return;
      natural.w = img.naturalWidth; natural.h = img.naturalHeight;

      const rect = img.getBoundingClientRect();
      const scaleX = rect.width / natural.w;
      const scaleY = rect.height / natural.h;

      const $logo = $("#box-logo");
      const $texto= $("#box-texto");

      // Tamanho da logo: usamos w como largura, altura proporcional (caixa visual)
      const logoWpx = logoW * scaleX;
      const logoHpx = Math.max(24, logoW * 0.6 * scaleY);
      $logo.style.width = `${logoWpx}px`;
      $logo.style.height= `${logoHpx}px`;
      $logo.style.left  = `${rect.left + window.scrollX + logoX*scaleX}px`;
      $logo.style.top   = `${rect.top  + window.scrollY + logoY*scaleY}px`;
      show($logo, true);

      // Texto: quando rotacionado 90/270, trocamos “largura/altura” da caixa
      let tW = txtW*scaleX*3; // caixa mais larga pra texto
      let tH = Math.max(18, txtW*scaleY);
      if((txtRot%180)!==0){ // vertical
        const tmp = tW; tW = tH; tH = tmp;
      }
      $texto.style.width = `${tW}px`;
      $texto.style.height= `${tH}px`;
      $texto.style.left  = `${rect.left + window.scrollX + txtX*scaleX}px`;
      $texto.style.top   = `${rect.top  + window.scrollY + txtY*scaleY}px`;
      show($texto, ($("#texto").value||textoVal).trim()!=='');

      // Badge some quando a caixa fica muito pequena
      [...$logo.querySelectorAll('.badge'), ...$texto.querySelectorAll('.badge')].forEach(b=>{
        const parent = b.parentElement;
        const pw = parent.getBoundingClientRect().width;
        const ph = parent.getBoundingClientRect().height;
        b.style.opacity = (pw<40 || ph<26) ? '0' : '1';
      });
    }

    // Atualiza botões de aprovação conforme índice
    function setApproveButtonText(){
      const btn = $("#aprovar");
      const total = produtos.length;
      const atual = idxAtual+1;
      if(atual<total){
        btn.textContent = `✅ Aprovar próximo produto (${atual+1} de ${total})`;
      }else{
        btn.textContent = `✅ Aprovar este produto`;
      }
    }

    /*************** LOAD DADOS ***************/
    async function loadLink(){
      const params = new URLSearchParams(location.search);
      linkId = params.get('p') || '';
      if(!linkId){ err('Link inválido. Use o formato ?p=SEU_ID'); return }

      const r = await q(`${SUPABASE_URL}/rest/v1/links_aprovacao?id=eq.${encodeURIComponent(linkId)}&select=*`);
      if(!r.ok){ err('Erro ao buscar dados do link.'); return }
      const js = await r.json();
      if(!js || !js.length){ err('Link não encontrado.'); return }

      const row = js[0];
      orderNumber = row.order_number || '—';

      // produtos pode ser array ou string JSON
      try{
        produtos = Array.isArray(row.produtos) ? row.produtos : JSON.parse(row.produtos);
      }catch(_){ produtos = [] }

      // Header
      setText($("#order-number"), orderNumber);
      setText($("#headline-order"), `Pedido #${orderNumber}`);

      // Dots
      const dots = $("#dots"); dots.innerHTML='';
      produtos.forEach((_,i)=>{
        const d=document.createElement('div'); d.className='dot'; d.id=`dot-${i}`; dots.appendChild(d);
      });

      // Primeiro produto
      loadProduto(0);
    }

    function loadProduto(i){
      idxAtual = i;
      const p = produtos[i] || {};
      const sku = p.sku || '—';
      const nome = p.nome || p.name || '—';

      setText($("#produto-sku"), sku);
      setText($("#produto-nome"), nome);
      setText($("#order-number"), orderNumber);

      // Progress dots
      produtos.forEach((_,k)=>{
        const d = $(`#dot-${k}`);
        d.classList.toggle('active', k===i);
      });

      // Limpa UI de preview até gerar novamente
      $("#canvas").src = '';
      show($("#preview-block"), false);
      $("#logo").value = '';         // não reaproveitar arquivo (corrige bug de “não pediu logo”)
      $("#texto").value = '';        // não duplicar texto
      fonte = 'Arial'; textoVal=''; hasText=false;
      logoRot=0; txtRot=0;
      logoX=0; logoY=400; logoW=100;
      txtX=0; txtY=520; txtW=50;

      setApproveButtonText();
    }

    /*************** MODAL PROGRESS ***************/
    let progTimer=null, prog=0;
    function openModal(){
      $("#modal").style.display='flex';
      prog=0; updateBar(0);
      progTimer=setInterval(()=>{
        prog = Math.min(92, prog+1.2);
        updateBar(prog);
      }, 160);
    }
    function closeModal(){
      if(progTimer) { clearInterval(progTimer); progTimer=null }
      updateBar(100);
      setTimeout(()=>$("#modal").style.display='none', 250);
    }
    function updateBar(v){
      $("#bar").style.width = `${Math.round(v)}%`;
      setText($("#pct"), `${Math.round(v)}%`);
    }

    /*************** PREVIEW ***************/
    async function gerarPrevia(){
      const p = produtos[idxAtual] || {};
      const file = $("#logo").files[0];
      const t = $("#texto").value.trim();
      const f = $("#fonte").value;

      if(!file){ err('Envie seu logo para gerar a prévia.'); return }

      openModal();

      const fd = new FormData();
      fd.append('logo', file);
      fd.append('texto', t);
      fd.append('fonte', f);
      fd.append('sku', p.sku || '');
      fd.append('cor', p.variante || p.variant || '');

      try{
        const r = await fetch(WEBHOOK_PREVIEW, { method:'POST', body:fd });
        // a resposta pode vir como [ {...} ] ou { ... }
        const raw = await r.text();
        let data = null;
        try{ data = JSON.parse(raw) }catch(_){}
        if(Array.isArray(data)) data = data[0];

        if(!r.ok || !data || !data.preview_url){
          closeModal();
          err('Erro ao gerar a prévia.'); return;
        }

        // Parse e “limpeza” de camadas
        parsePreviewURL(data.preview_url);

        // Força o texto a considerar o campo atual (evita duplicação vinda do preview inicial)
        const finalText = t;
        if(finalText===''){ hasText=false; textoVal='' } else { hasText=true; textoVal=finalText; fonte=f }

        // Render base já com 1x logo e (se houver) 1x texto
        const finalURL = buildURL();
        const img = $("#canvas");
        img.onload = ()=>{ positionBoxes(); show($("#preview-block"), true); closeModal() };
        img.onerror = ()=>{ closeModal(); err('Falha ao carregar a imagem da prévia.') };
        img.src = finalURL;

      }catch(e){
        closeModal();
        err('Falha de conexão ao gerar a prévia.');
      }
    }

    /*************** DRAG & RESIZE ***************/
    function boxFromTarget(el){
      if(!el) return null;
      if(el.id==='box-logo') return 'logo';
      if(el.id==='box-texto') return 'texto';
      const par = el.closest('.layer-box');
      if(!par) return null;
      return par.id==='box-logo' ? 'logo' : 'texto';
    }

    function toImageSpace(dx, dy){
      const img=$("#canvas");
      const rect=img.getBoundingClientRect();
      const sx = natural.w/rect.width;
      const sy = natural.h/rect.height;
      return { dx: dx*sx, dy: dy*sy };
    }

    function onPointerDown(e){
      const target = e.target;
      const which = boxFromTarget(target);
      if(!which) return;

      e.preventDefault();

      dragTarget = which;
      resizing = target.classList.contains('handle');
      resizeCorner = resizing ? [...target.classList].find(c=>/^(tl|tr|bl|br)$/.test(c)) : null;

      const box = which==='logo' ? $("#box-logo") : $("#box-texto");
      const r = box.getBoundingClientRect();

      start.x = e.clientX; start.y = e.clientY;
      start.w = r.width; start.h = r.height;

      if(which==='logo'){ start.X = logoX; start.Y = logoY }
      else{ start.X = txtX; start.Y = txtY }

      document.addEventListener('pointermove', onPointerMove);
      document.addEventListener('pointerup', onPointerUp);
    }
    function onPointerMove(e){
      if(!dragTarget) return;
      const dx = e.clientX - start.x;
      const dy = e.clientY - start.y;
      const {dx:ix, dy:iy} = toImageSpace(dx, dy);

      if(dragTarget==='logo'){
        if(resizing){
          // resize proporcional pela largura
          const sign = (resizeCorner==='tr'||resizeCorner==='br') ? 1 : -1;
          logoW = clamp(start.w + dx*sign, 20, 2000) * (natural.w / $("#canvas").getBoundingClientRect().width);
        }else{
          logoX = clamp(start.X + ix, 0, natural.w-24);
          logoY = clamp(start.Y + iy, 0, natural.h-24);
        }
      }else{
        if(resizing){
          const sign = (resizeCorner==='tr'||resizeCorner==='br') ? 1 : -1;
          txtW = clamp(start.w + dx*sign, 10, 2000) * (natural.w / $("#canvas").getBoundingClientRect().width) / ( (txtRot%180)===0 ? 1 : 3 );
        }else{
          txtX = clamp(start.X + ix, 0, natural.w-24);
          txtY = clamp(start.Y + iy, 0, natural.h-24);
        }
      }
      positionBoxes();
      // Atualiza imagem “de verdade” só quando parar de arrastar? Aqui atualizamos “ao vivo”:
      refreshPreview();
    }
    function onPointerUp(){
      dragTarget=null; resizing=false; resizeCorner=null;
      document.removeEventListener('pointermove', onPointerMove);
      document.removeEventListener('pointerup', onPointerUp);
    }

    /*************** BUTTONS ***************/
    function rotLogo(){ logoRot = (logoRot+90)%360; refreshPreview() }
    function rotTexto(){ txtRot  = (txtRot +90)%360; refreshPreview() }
    function resetAll(){
      logoX=0; logoY=400; logoW=100; logoRot=0;
      txtX=0;  txtY=520;  txtW=50;  txtRot=0;
      positionBoxes(); refreshPreview();
    }

    async function aprovar(){
      const p = produtos[idxAtual] || {};
      const finalURL = buildURL();
      if(!finalURL){ err('Gere a prévia primeiro.'); return }

      const payload = {
        link_id: linkId,
        order_number: orderNumber,
        produto_index: idxAtual,
        produto_sku: p.sku || '',
        produto_nome: p.nome || p.name || '',
        produto_variante: p.variante || '',
        mockup_url: finalURL,
        logo: { x:logoX, y:logoY, w:logoW, rot:logoRot, id:logoId },
        texto: { x:txtX, y:txtY, w:txtW, rot:txtRot, fonte, conteudo: ($("#texto").value||textoVal||'') },
        timestamp: new Date().toISOString()
      };

      $("#aprovar").disabled = true;
      try{
        const r = await fetch(WEBHOOK_APROVACAO, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if(!r.ok) throw new Error('Falha no salvamento');
      }catch(e){
        $("#aprovar").disabled = false;
        err('Erro ao aprovar. Tente novamente.'); return;
      }

      // Marca dot e segue
      $(`#dot-${idxAtual}`)?.classList.add('done');

      if(idxAtual < produtos.length-1){
        loadProduto(idxAtual+1);
      }else{
        // Fim
        $(".panel").style.display='none';
        $("#done").style.display='block';
      }
      $("#aprovar").disabled = false;
    }

    /*************** WIRE UP ***************/
    window.addEventListener('resize', positionBoxes);
    window.addEventListener('load', loadLink);

    $("#btn-gerar").addEventListener('click', gerarPrevia);
    $("#rot-logo").addEventListener('click', rotLogo);
    $("#rot-texto").addEventListener('click', rotTexto);
    $("#reset").addEventListener('click', resetAll);
    $("#aprovar").addEventListener('click', aprovar);

    // Pointer listeners para as caixas
    $("#box-logo").addEventListener('pointerdown', onPointerDown);
    $("#box-texto").addEventListener('pointerdown', onPointerDown);

    // Inicial: esconde preview até gerar
    show($("#preview-block"), false);
  </script>
</body>
</html>
