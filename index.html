<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mockup Interativo ‚Äì Gama Laser</title>
<style>
  :root{
    --bg:#1b120e; --panel:#2a1f1a; --ink:#f6f3f2; --muted:#9adfbc; --accent:#ffb703;
    --primary:#29d391; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(1200px 60% at 50% 100%, #000 0%, var(--bg) 55%);
    color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji', 'Segoe UI Symbol';
    display:flex; align-items:center; justify-content:center; min-height:100dvh; padding:16px;
  }
  .app{width:min(100%, 980px); display:grid; gap:16px; grid-template-columns: 1fr 320px}
  @media (max-width: 860px){ .app{grid-template-columns: 1fr} }
  .stage-wrap{background:#120c0a; padding:22px 18px; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .stage{position:relative; width:100%; aspect-ratio: 4/3; background:#fff; border-radius:12px; overflow:hidden; user-select:none}
  .stage img.base{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; pointer-events:none}
  /* draggable layers */
  .layer{position:absolute; translate:-50% -50%; /* we position by center for consist√™ncia */
         outline:2px dashed rgba(0,0,0,.25); border-radius:6px}
  .layer .tag{position:absolute; top:-26px; left:-6px; font-size:11px; font-weight:700;
              background:#000; color:#fff; padding:4px 6px; border-radius:6px}
  .handles{position:absolute; inset:-8px; pointer-events:none}
  .handle{position:absolute; width:12px; height:12px; border:2px solid currentColor; border-radius:3px;
          background:#fff; color:#07f; pointer-events:auto; cursor:nwse-resize}
  .handle.br{right:-6px; bottom:-6px}
  .handle.tl{left:-6px; top:-6px}
  /* TEXT content */
  .text-content{display:flex; align-items:center; justify-content:center; padding:6px 10px; white-space:pre;
                line-height:1; transform-origin:center; color:#000}
  .text-vertical{writing-mode:vertical-rl}
  /* LOGO content */
  .logo-content img{display:block; width:100%; height:100%; object-fit:contain; pointer-events:none}

  /* sidebar controls */
  .panel{background:var(--panel); border-radius:18px; padding:16px; display:flex; flex-direction:column; gap:12px}
  .box{background:#16110f; border-radius:12px; padding:12px}
  .btn{display:flex; align-items:center; justify-content:center; gap:8px; width:100%; border:0; border-radius:12px; padding:12px;
       font-weight:700; color:#08130e; background:var(--primary); cursor:pointer}
  .btn.secondary{background:#3dd3ff; color:#00131a}
  .btn.warn{background:#ffd166; color:#1a1300}
  .btn.danger{background:var(--danger); color:#2b0a0a}
  .btn:active{transform:translateY(1px)}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .coord{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
         color:#9adfbc; font-size:12px; line-height:1.35}
  label{font-size:12px; opacity:.8; display:block; margin-bottom:6px}
  input[type="text"]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #3b2b24; background:#0e0a08; color:#eee}
  select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #3b2b24; background:#0e0a08; color:#eee}
  .pill{display:inline-flex; padding:.25rem .5rem; border:1px solid #41332b; border-radius:999px; gap:.5rem; font-size:12px}
</style>
</head>
<body>
  <main class="app">
    <section class="stage-wrap">
      <div id="stage" class="stage" aria-label="√°rea do mockup">
        <img id="baseImg" class="base" alt="mockup base" />
        <!-- TEXT LAYER -->
        <div id="textLayer" class="layer" data-type="text" style="left:55%; top:27%;">
          <div class="tag">üñäÔ∏è TEXTO</div>
          <div id="textContent" class="text-content" contenteditable="true" spellcheck="false">teste</div>
          <div class="handles">
            <div class="handle tl" data-resize="tl"></div>
            <div class="handle br" data-resize="br"></div>
          </div>
        </div>
        <!-- LOGO LAYER -->
        <div id="logoLayer" class="layer" data-type="logo" style="left:32%; top:28%; width:100px; height:100px;">
          <div class="tag">üß∑ LOGO</div>
          <div class="logo-content"><img id="logoImg" alt="logo" /></div>
          <div class="handles">
            <div class="handle tl" data-resize="tl"></div>
            <div class="handle br" data-resize="br"></div>
          </div>
        </div>
      </div>
    </section>

    <aside class="panel">
      <div class="box">
        <div class="pill">‚òÅÔ∏è Cloudinary: <strong id="cloudName">dslzqtajk</strong></div>
        <div style="height:8px"></div>
        <label for="logoSelect">Logo</label>
        <select id="logoSelect">
          <!-- Coloque aqui os public_id que voc√™ usa com mais frequ√™ncia -->
          <option value="logo_3017D_1760207385277">logo_3017D_1760207385277</option>
        </select>
        <label for="baseSelect">Mockup base</label>
        <select id="baseSelect">
          <option value="mockups/3017d_azul">mockups/3017d_azul</option>
        </select>
      </div>

      <div class="box">
        <label>Texto</label>
        <input id="textInput" type="text" value="teste" />
        <div class="row" style="margin-top:8px">
          <button id="toggleVertical" class="btn secondary">‚ÜïÔ∏è Texto Vertical</button>
          <button id="rotateText90" class="btn warn">‚§¥Ô∏è Rotacionar 90¬∞</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="textMinus" class="btn danger">‚àí Diminuir Texto</button>
          <button id="textPlus" class="btn">+ Aumentar Texto</button>
        </div>
      </div>

      <div class="box">
        <label>Logo</label>
        <div class="row">
          <button id="logoRotate90" class="btn warn">‚§¥Ô∏è Rotacionar Logo 90¬∞</button>
          <button id="resetAll" class="btn danger">‚Ü∫ Resetar</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="logoMinus" class="btn danger">‚àí Diminuir Logo</button>
          <button id="logoPlus" class="btn">+ Aumentar Logo</button>
        </div>
      </div>

      <div class="box">
        <div class="coord" id="coordBox">‚Äî</div>
      </div>

      <button id="approve" class="btn">‚úÖ APROVAR ESTE PRODUTO</button>
    </aside>
  </main>

<script>
/* ================== CONFIG ================== */
const CLOUD_NAME = 'dslzqtajk';
const DEFAULTS = {
  basePublicId: 'mockups/3017d_azul',
  logoPublicId: 'logo_3017D_1760207385277',
  text: 'teste'
};

/* =============== STATE (fonte de verdade) =============== */
const state = {
  basePublicId: DEFAULTS.basePublicId,
  logoPublicId: DEFAULTS.logoPublicId,
  logo: { x: 0.32, y: 0.28, w: 100, h: 100, rot: 0 },     // relativos ao stage (x,y em % via center)
  text: { x: 0.55, y: 0.27, font: 28, rot: 0, vertical: false, value: DEFAULTS.text },
};

/* =============== ELEMENTOS =============== */
const stage = document.getElementById('stage');
const baseImg = document.getElementById('baseImg');
const logoLayer = document.getElementById('logoLayer');
const logoImg   = document.getElementById('logoImg');
const textLayer = document.getElementById('textLayer');
const textContent = document.getElementById('textContent');

const coordBox = document.getElementById('coordBox');
const textInput = document.getElementById('textInput');
const toggleVertical = document.getElementById('toggleVertical');
const rotateText90 = document.getElementById('rotateText90');
const textMinus = document.getElementById('textMinus');
const textPlus  = document.getElementById('textPlus');
const logoRotate90 = document.getElementById('logoRotate90');
const logoMinus = document.getElementById('logoMinus');
const logoPlus  = document.getElementById('logoPlus');
const resetAll  = document.getElementById('resetAll');
const approveBtn = document.getElementById('approve');
const logoSelect = document.getElementById('logoSelect');
const baseSelect = document.getElementById('baseSelect');

/* =============== HELPERS =============== */
const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
const px = n => `${Math.round(n)}px`;
const debounce = (fn, ms=400) => {
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
};
function stageRect(){ return stage.getBoundingClientRect(); }
function applyPositions(){
  const r = stageRect();
  // TEXT
  textContent.textContent = state.text.value || '';
  textContent.style.fontSize = px(state.text.font);
  textLayer.style.left = `${state.text.x*100}%`;
  textLayer.style.top  = `${state.text.y*100}%`;
  const cls = 'text-vertical';
  textContent.classList.toggle(cls, state.text.vertical);
  textContent.style.transform = `rotate(${state.text.rot}deg)`;
  // After styling, resize the wrapper to bound the rotated content
  requestAnimationFrame(()=>{
    const b = textContent.getBoundingClientRect();
    const w = Math.max(30, b.width);
    const h = Math.max(24, b.height);
    textLayer.style.width = px(w);
    textLayer.style.height= px(h);
    // outline colors for clarity
    textLayer.style.outlineColor='#3aa7ff';
    updateCoords();
  });

  // LOGO
  logoLayer.style.left = `${state.logo.x*100}%`;
  logoLayer.style.top  = `${state.logo.y*100}%`;
  logoLayer.style.width = px(state.logo.w);
  logoLayer.style.height= px(state.logo.h);
  logoLayer.style.transform = `translate(-50%,-50%) rotate(${state.logo.rot}deg)`;

  updatePreviewDebounced();
}
function updateCoords(){
  const r = stageRect();
  const tx = Math.round(state.text.x * r.width);
  const ty = Math.round(state.text.y * r.height);
  const lx = Math.round(state.logo.x * r.width);
  const ly = Math.round(state.logo.y * r.height);
  const info = [
    `üìç Coordenadas:`,
    `Logo ‚Äî X:${lx} Y:${ly} W:${state.logo.w} Rot:${state.logo.rot}¬∞`,
    `Texto ‚Äî X:${tx} Y:${ty} Font:${state.text.font} Rot:${state.text.rot}¬∞ ${state.text.vertical?'(V)':''}`
  ].join('\n');
  coordBox.textContent = info;
}

/* ======= CLOUDINARY URL BUILDER (preview) ======= */
function buildCloudinaryURL(){
  // Base
  const base = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/`;

  // LOGO overlay
  const r = stageRect();
  const lx = Math.round(state.logo.x*r.width);
  const ly = Math.round(state.logo.y*r.height);
  const logoW = Math.round(state.logo.w);
  const logoSeg =
    `l_${encodeURIComponent(state.logoPublicId)},e_bgremoval,w_${logoW},g_north_west,`+
    `x_${lx},y_${ly},a_${((state.logo.rot%360)+360)%360},fl_layer_apply/`;

  // TEXT overlay ‚Äì usamos l_text; quando vertical, usamos rota√ß√£o 90 e writing-mode visual apenas para o overlay local
  const tx = Math.round(state.text.x*r.width);
  const ty = Math.round(state.text.y*r.height);
  const fontPx = Math.max(8, Math.round(state.text.font));
  const extraRot = state.text.vertical ? 90 : 0;
  const totalRot = ((state.text.rot + extraRot)%360+360)%360;
  const textValue = (state.text.value || ' ').replace(/\//g,'\\/');
  const textSeg =
    `l_text:Arial_${fontPx}:${encodeURIComponent(textValue)},co_rgb:000000,g_north_west,`+
    `x_${tx},y_${ty},a_${totalRot},fl_layer_apply/`;

  return `${base}${logoSeg}${textSeg}${encodeURIComponent(state.basePublicId)}`;
}
const updatePreviewDebounced = debounce(()=>{
  baseImg.src = buildCloudinaryURL();
}, 400);

/* =============== DRAG / RESIZE (independentes) =============== */
function initDrag(layer, kind){
  let dragging=false, resizing=false, start={}, rectS, stageR;
  const onDown = (e)=>{
    if(e.target.classList.contains('handle')){ // resize
      e.stopPropagation();
      resizing = e.target.dataset.resize;
    }else{
      dragging = true;
    }
    rectS = layer.getBoundingClientRect();
    stageR = stageRect();
    start = {x:(e.touches?e.touches[0].clientX:e.clientX), y:(e.touches?e.touches[0].clientY:e.clientY)};
    document.addEventListener('pointermove', onMove);
    document.addEventListener('pointerup', onUp);
  };
  const onMove = (e)=>{
    const cx = (e.touches?e.touches[0].clientX:e.clientX);
    const cy = (e.touches?e.touches[0].clientY:e.clientY);
    const dx = cx - start.x;
    const dy = cy - start.y;

    if(dragging){
      const nx = clamp((rectS.left + dx - stageR.left + rectS.width/2) / stageR.width, 0.02, 0.98);
      const ny = clamp((rectS.top  + dy - stageR.top  + rectS.height/2) / stageR.height, 0.02, 0.98);
      if(kind==='text'){ state.text.x = nx; state.text.y = ny; }
      else{ state.logo.x = nx; state.logo.y = ny; }
      applyPositions();
    }
    if(resizing){
      // s√≥ usamos diagonal BR para simplicidade
      const w = Math.max(24, rectS.width + dx * (resizing==='br'?1:-1));
      const h = Math.max(24, rectS.height + dy * (resizing==='br'?1:-1));
      if(kind==='text'){
        // converte largura em varia√ß√£o de font-size aproximada
        const factor = w / rectS.width;
        state.text.font = Math.max(8, Math.round(state.text.font * factor));
      }else{
        const factor = w / rectS.width;
        state.logo.w = Math.max(24, Math.round(state.logo.w * factor));
        state.logo.h = state.logo.w; // mant√©m propor√ß√£o
      }
      applyPositions();
      start.x = cx; start.y = cy; // incremental para suavizar
      rectS = layer.getBoundingClientRect();
    }
  };
  const onUp = ()=>{
    dragging=false; resizing=false;
    document.removeEventListener('pointermove', onMove);
    document.removeEventListener('pointerup', onUp);
  };
  layer.addEventListener('pointerdown', onDown);
  // Evita que cliques em um layer ‚Äúpuxem‚Äù o outro
  layer.addEventListener('pointerdown', e=>e.stopPropagation());
}
initDrag(textLayer, 'text');
initDrag(logoLayer, 'logo');

/* =============== CONTROLES =============== */
textInput.addEventListener('input', ()=>{
  state.text.value = textInput.value;
  applyPositions();
});
textContent.addEventListener('input', ()=>{
  state.text.value = textContent.textContent;
  textInput.value = state.text.value;
  applyPositions();
});
toggleVertical.addEventListener('click', ()=>{
  state.text.vertical = !state.text.vertical;
  applyPositions();
});
rotateText90.addEventListener('click', ()=>{
  state.text.rot = (state.text.rot + 90) % 360;
  applyPositions();
});
textMinus.addEventListener('click', ()=>{ state.text.font = Math.max(8, state.text.font-2); applyPositions(); });
textPlus .addEventListener('click', ()=>{ state.text.font = Math.min(200, state.text.font+2); applyPositions(); });

logoRotate90.addEventListener('click', ()=>{ state.logo.rot = (state.logo.rot + 90) % 360; applyPositions(); });
logoMinus.addEventListener('click', ()=>{ state.logo.w = Math.max(24, state.logo.w-6); state.logo.h = state.logo.w; applyPositions(); });
logoPlus .addEventListener('click', ()=>{ state.logo.w = Math.min(800, state.logo.w+6); state.logo.h = state.logo.w; applyPositions(); });

resetAll.addEventListener('click', ()=>{
  Object.assign(state, {
    basePublicId: DEFAULTS.basePublicId,
    logoPublicId: DEFAULTS.logoPublicId,
    logo: { x: 0.32, y: 0.28, w:100, h:100, rot:0 },
    text: { x: 0.55, y: 0.27, font:28, rot:0, vertical:false, value: DEFAULTS.text }
  });
  textInput.value = state.text.value;
  logoSelect.value = state.logoPublicId;
  baseSelect.value = state.basePublicId;
  applyPositions();
});

logoSelect.addEventListener('change', ()=>{
  state.logoPublicId = logoSelect.value;
  applyPositions();
});
baseSelect.addEventListener('change', ()=>{
  state.basePublicId = baseSelect.value;
  applyPositions();
});

approveBtn.addEventListener('click', ()=>{
  // Gera URL final (sem debounce) para salvar/compartilhar
  const url = buildCloudinaryURL();
  alert('URL gerada:\n' + url);
  // voc√™ pode enviar essa URL ao seu backend aqui
});

/* =============== BOOT =============== */
(function init(){
  logoImg.src = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${encodeURIComponent(state.logoPublicId)}.png`;
  baseImg.alt = state.basePublicId.split('/').pop();
  textInput.value = state.text.value;
  logoSelect.value = state.logoPublicId;
  baseSelect.value = state.basePublicId;
  applyPositions(); // tamb√©m dispara preview
})();
</script>
</body>
</html>
